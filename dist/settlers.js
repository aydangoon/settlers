(()=>{var e={562:function(e,t,r){var n=this&&this.__read||function(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var n,o,i=r.call(e),a=[];try{for(;(void 0===t||t-- >0)&&!(n=i.next()).done;)a.push(n.value)}catch(e){o={error:e}}finally{try{n&&!n.done&&(r=i.return)&&r.call(i)}finally{if(o)throw o.error}}return a},o=this&&this.__spreadArray||function(e,t,r){if(r||2===arguments.length)for(var n,o=0,i=t.length;o<i;o++)!n&&o in t||(n||(n=Array.prototype.slice.call(t,0,o)),n[o]=t[o]);return e.concat(n||Array.prototype.slice.call(t))};System.register("game/dev_card/dev_card",[],(function(e,t){"use strict";var r;return t&&t.id,{setters:[],execute:function(){!function(e){e[e.Knight=0]="Knight",e[e.VictoryPoint=1]="VictoryPoint",e[e.YearOfPlenty=2]="YearOfPlenty",e[e.Monopoly=3]="Monopoly",e[e.RoadBuilder=4]="RoadBuilder"}(r||(r={})),e("DevCard",r),e("devCardStr",(function(e){switch(e){case r.Knight:return"knight";case r.VictoryPoint:return"victory point";case r.YearOfPlenty:return"yop";case r.Monopoly:return"monopoly";default:return"road builder"}})),e("default",r)}}})),System.register("game/resource/resource",[],(function(e,t){"use strict";var r;return t&&t.id,{setters:[],execute:function(){!function(e){e[e.Brick=0]="Brick",e[e.Lumber=1]="Lumber",e[e.Ore=2]="Ore",e[e.Grain=3]="Grain",e[e.Wool=4]="Wool",e[e.None=5]="None"}(r||(r={})),e("Resource",r),e("resStr",(function(e){switch(e){case r.Brick:return"brick";case r.Lumber:return"lumber";case r.Ore:return"ore";case r.Grain:return"grain";case r.Wool:return"wool";default:return"none"}})),e("default",r)}}})),System.register("game/constants",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){e("NUM_RESOURCE_TYPES",5),e("NUM_EACH_RESOURCE_TILE",[3,4,3,4,4]),e("NUM_DEV_CARD_TYPES",5),e("NUM_PLAYERS",4),e("NUM_SETTLEMENTS",5),e("NUM_CITIES",4),e("NUM_ROADS",15),e("NUM_EACH_RESOURCE",19),e("NUM_VPS",5),e("NUM_KNIGHTS",14),e("NUM_ROAD_BUILDING",2),e("NUM_YEAR_OF_PLENTY",2),e("NUM_MONOPOLY",2),e("RES_PER_SETTLEMENT",1),e("RES_PER_CITY",2),e("MIN_LONGEST_ROAD",5),e("MIN_LARGEST_ARMY",3),e("BANK_RATE",4),e("VPS_TO_WIN",10),e("ROBBER_LIMIT",7),e("NUM_NODES",54),e("NUM_EDGES",72),e("NUM_TILES",19),e("HAVE_PORTS",[[0,1],[3,4],[7,17],[14,15],[26,37],[28,38],[45,46],[47,48],[50,51]])}}})),System.register("game/board/graph",[],(function(e,t){"use strict";var r;return t&&t.id,{setters:[],execute:function(){r=function(){function e(){for(var e=this,t=[],r=0;r<arguments.length;r++)t[r]=arguments[r];if(this.keyOf=function(t){return e.keys.get(t)},this.hasNode=function(t){return e.keys.has(t)},this.hasEdge=function(t,r){if(!e.hasNode(t))return!1;for(var n=0;n<e.al[e.keyOf(t)].length;n++)if(e.al[e.keyOf(t)][n][0]===r)return!0;return!1},this.degree=function(t){return e.hasNode(t)?e.al[e.keyOf(t)].length:0},this.children=function(t){for(var r=[],n=0;n<e.al[e.keyOf(t)].length;n++)r.push(e.al[e.keyOf(t)][n][0]);return r},this.nodeCount=function(){return e.al.length},this.nodes=function(){return o([],n(e.keys.keys()),!1)},this.edgeCount=function(){for(var t=0,r=o([],n(e.keys.keys()),!1),i=0;i<r.length;i++)t+=e.degree(r[i]);return Math.floor(t/2)},this.al=[],this.keys=new Map,Array.isArray(t[0][0]))for(var i=t[0],a=0;a<i.length;a++){var s=n(i[a],2),u=s[0],c=s[1];u!==c&&(this.hasNode(u)?this.al[this.keyOf(u)].push([c,-1]):(this.keys.set(u,this.al.length),this.al.push([[c,-1]])),this.hasNode(c)?this.al[this.keyOf(c)].push([u,-1]):(this.keys.set(c,this.al.length),this.al.push([[u,-1]])))}else{var d=t[0];for(a=0;a<d.length;a++)this.hasNode(d[a])||(this.keys.set(d[a],this.al.length),this.al.push([]))}}return e.prototype.addEdge=function(e,t,r){void 0===r&&(r=-1),this.hasNode(e)&&this.hasNode(t)&&!this.hasEdge(e,t)&&(this.al[this.keyOf(e)].push([t,r]),this.al[this.keyOf(t)].push([e,r]))},e.prototype.deleteEdge=function(e,t){this.hasNode(e)&&this.hasNode(t)&&this.hasEdge(e,t)&&(this.al[this.keyOf(e)].splice(this.al[this.keyOf(e)].findIndex((function(e){return n(e,1)[0]===t})),1),this.al[this.keyOf(t)].splice(this.al[this.keyOf(t)].findIndex((function(t){return n(t,1)[0]===e})),1))},e.prototype.getWeight=function(e,t){if(!this.hasEdge(e,t))return-1;for(var r=this.al[this.keyOf(e)],n=0;n<r.length;n++)if(r[n][0]===t)return r[n][1];return-1},e.prototype.setWeight=function(e,t,r){if(this.hasEdge(e,t)){var o=this.al[this.keyOf(e)];o[o.findIndex((function(e){return n(e,1)[0]===t}))][1]=r,(o=this.al[this.keyOf(t)])[o.findIndex((function(t){return n(t,1)[0]===e}))][1]=r}},e}(),e("Graph",r),e("default",r)}}})),System.register("game/utils",["game/board/graph"],(function(e,t){"use strict";var r,i,a;function s(e,t,r){var n,o,i=t.children(e).filter((function(t){return!r.hasEdge(e,t)}));return 0===i.length?0:(n=i[0],r.addEdge(n,e),o=1+s(n,t,r),r.deleteEdge(n,e),2===i.length&&(n=i[1],r.addEdge(n,e),o=Math.max(o,1+s(n,t,r)),r.deleteEdge(n,e)),o)}return t&&t.id,e("maxTrailRec",s),{setters:[function(e){r=e}],execute:function(){e("weightedRandom",(function(e){for(var t=e.reduce((function(e,t){return e+t})),r=Math.random()*t,n=0;n<e.length;n++)if((r-=e[n])<=0)return n;return-1})),e("rollDie",(function(){return i(1,6)})),e("uniformRandom",i=function(e,t){return Math.floor(Math.random()*(t-e+1))+e}),e("maxTrail",(function(e,t){var n=new r.default(e.nodes());return s(t,e,n)})),e("connectedComponents",(function(e){for(var t=e.nodes(),i=[],s=function(){for(var s=t[0],u=a(e,s).visited,c=o([],n(u),!1),d=new r.default(c),l=0;l<c.length;l++)for(var f=l+1;f<c.length;f++)e.hasEdge(c[l],c[f])&&d.addEdge(c[l],c[f]);i.push(d),t=t.filter((function(e){return!u.has(e)}))};t.length>0;)s();return i})),e("breadthFirstSearch",a=function(e,t){var r=[t],i=new Set([t]),a=new Map;for(a.set(t,0);r.length>0;)for(var s=r.pop(),u=e.children(s),c=0;c<u.length;c++){var d=u[c];i.has(d)||(r.unshift(d),i.add(d),a.set(d,a.get(s)+1))}return{visited:i,depth:Math.max.apply(Math,o([],n(a.values()),!1))}})}}})),System.register("game/loggable",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){}}})),System.register("game/resource/resource_bundle",["game/resource/resource","game/constants","game/utils"],(function(e,t){"use strict";var r,i,a,s;return t&&t.id,{setters:[function(e){r=e},function(e){i=e},function(e){a=e}],execute:function(){s=function(){function e(){for(var e=this,t=[],a=0;a<arguments.length;a++)t[a]=arguments[a];if(this.toLog=function(){return e.bundle.map((function(e,t){return"".concat(r.resStr(t),": ").concat(e)})).join(", ")},0===t.length)this.bundle=o([],n(Array(i.NUM_RESOURCE_TYPES)),!1).map((function(){return 0}));else if("number"==typeof t[0]){var s=n(t,1),u=s[0];this.bundle=o([],n(Array(i.NUM_RESOURCE_TYPES)),!1).map((function(){return u}))}else{var c=n(t,1),d=c[0];this.bundle=o([],n(Array(i.NUM_RESOURCE_TYPES)),!1);for(var l=0;l<i.NUM_RESOURCE_TYPES;l++)this.bundle[l]=d[l]}}return e.prototype.has=function(e){for(var t=0;t<i.NUM_RESOURCE_TYPES;t++)if(this.bundle[t]<e.get(t))return!1;return!0},e.prototype.get=function(e){return this.bundle[e]},e.prototype.set=function(e,t){this.bundle[e]=t},e.prototype.add=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];if(1===e.length)for(var r=n(e,1),o=r[0],a=0;a<i.NUM_RESOURCE_TYPES;a++)this.bundle[a]+=o.get(a);else{var s=n(e,2),u=s[0],c=s[1];this.bundle[u]+=c}},e.prototype.subtract=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];if(1===e.length)for(var r=n(e,1),o=r[0],a=0;a<i.NUM_RESOURCE_TYPES;a++)this.bundle[a]-=o.get(a);else{var s=n(e,2),u=s[0],c=s[1];this.add(u,-1*c)}},e.trade=function(e,t,r,n){t.add(r),n.subtract(r),n.add(e),t.subtract(e)},e.prototype.removeAll=function(e){var t=this.bundle[e];return this.bundle[e]=0,t},e.prototype.removeOneAtRandom=function(){var e=a.weightedRandom(this.bundle);return this.bundle[e]--,e},e.prototype.size=function(){return this.bundle.reduce((function(e,t){return e+t}))},e.prototype.isEmpty=function(){return 0===this.size()},e.roadCost=new e([1,1,0,0,0]),e.settlementCost=new e([1,1,0,1,1]),e.cityCost=new e([0,0,3,2,0]),e.devCardCost=new e([0,0,1,1,1]),e}(),e("ResourceBundle",s),e("default",s)}}})),System.register("game/trade_offer",["game/constants"],(function(e,t){"use strict";var r,i,a;return t&&t.id,{setters:[function(e){r=e}],execute:function(){!function(e){e[e.Pending=0]="Pending",e[e.Accept=1]="Accept",e[e.Decline=2]="Decline"}(i||(i={})),e("TradeStatus",i),e("TradeOffer",a=function(e,t,a,s){var u=this;this.allDeclined=function(){return u.status.filter((function(e){return e===i.Decline})).length===r.NUM_PLAYERS-1},this.id=e,this.offerer=t,this.offer=a,this.request=s,this.status=o([],n(Array(r.NUM_PLAYERS)),!1).map((function(){return i.Pending})),this.status[t]=i.Accept}),e("default",a)}}})),System.register("game/action",[],(function(e,t){"use strict";var r,n;return t&&t.id,{setters:[],execute:function(){!function(e){e[e.Roll=0]="Roll",e[e.PlayRobber=1]="PlayRobber",e[e.MoveRobber=2]="MoveRobber",e[e.Rob=3]="Rob",e[e.PlayMonopoly=4]="PlayMonopoly",e[e.SelectMonopolyResource=5]="SelectMonopolyResource",e[e.PlayYearOfPlenty=6]="PlayYearOfPlenty",e[e.SelectYearOfPlentyResources=7]="SelectYearOfPlentyResources",e[e.PlayRoadBuilder=8]="PlayRoadBuilder",e[e.BuildSettlement=9]="BuildSettlement",e[e.BuildCity=10]="BuildCity",e[e.BuildRoad=11]="BuildRoad",e[e.Discard=12]="Discard",e[e.MakeTradeOffer=13]="MakeTradeOffer",e[e.DecideOnTradeOffer=14]="DecideOnTradeOffer",e[e.DrawDevCard=15]="DrawDevCard",e[e.Exchange=16]="Exchange",e[e.EndTurn=17]="EndTurn"}(r||(r={})),e("ActionType",r),e("actionTypeStr",(function(e){switch(e){case r.Roll:return"Roll";case r.PlayRobber:return"Play Robber";case r.MoveRobber:return"Move Robber";case r.Rob:return"Rob";case r.PlayMonopoly:return"Play Monopoly";case r.SelectMonopolyResource:return"Select Monopoly Resource";case r.PlayYearOfPlenty:return"Play YOP";case r.SelectYearOfPlentyResources:return"Select YOP Resources";case r.PlayRoadBuilder:return"Play Road Builder";case r.BuildSettlement:return"Build Settlement";case r.BuildCity:return"Build City";case r.BuildRoad:return"Build Road";case r.Discard:return"Discard";case r.MakeTradeOffer:return"Make Trade Offer";case r.DecideOnTradeOffer:return"Decide on Trade Offer";case r.DrawDevCard:return"Draw Dev Card";case r.Exchange:return"Exchange";default:return"End Turn"}})),n=function(){function e(e,t,r){var n=this;void 0===t&&(t=0),void 0===r&&(r={}),this.serialized=function(){return JSON.stringify(n)},this.type=e,this.player=t,this.payload=r}return e.deserialize=function(t){var r=JSON.parse(t),n=r.type,o=r.payload;return new e(n,r.player,o)},e}(),e("Action",n),e("default",n)}}})),System.register("game/dev_card/dev_card_bundle",["game/dev_card/dev_card","game/constants","game/utils"],(function(e,t){"use strict";var r,i,a,s;return t&&t.id,{setters:[function(e){r=e},function(e){i=e},function(e){a=e}],execute:function(){s=function(){function e(){for(var e=this,t=[],a=0;a<arguments.length;a++)t[a]=arguments[a];if(this.toLog=function(){return e.bundle.map((function(e,t){return"".concat(r.devCardStr(t),": ").concat(e)})).join(", ")},0===t.length)this.bundle=o([],n(Array(i.NUM_DEV_CARD_TYPES)),!1).map((function(){return 0}));else if("number"==typeof t[0]){var s=n(t,1),u=s[0];this.bundle=o([],n(Array(i.NUM_DEV_CARD_TYPES)),!1).map((function(){return u}))}else{var c=n(t,1),d=c[0];this.bundle=o([],n(Array(i.NUM_DEV_CARD_TYPES)),!1);for(var l=0;l<i.NUM_DEV_CARD_TYPES;l++)this.bundle[l]=d[l]}}return e.prototype.add=function(e){this.bundle[e]++},e.prototype.remove=function(e){this.bundle[e]--},e.prototype.has=function(e){return 0!==this.bundle[e]},e.prototype.pickOneAtRandom=function(){return a.weightedRandom(this.bundle)},e.prototype.size=function(){return this.bundle.reduce((function(e,t){return e+t}))},e.prototype.isEmpty=function(){return 0===this.size()},e}(),e("DevCardBundle",s),e("default",s)}}})),System.register("game/player",["game/constants","game/dev_card/dev_card_bundle","game/resource/resource_bundle"],(function(e,t){"use strict";var r,n,o,i;return t&&t.id,{setters:[function(e){r=e},function(e){n=e},function(e){o=e}],execute:function(){e("Player",i=function(){var e=this;this.toLog=function(){return"resources: [ ".concat(e.resources.toLog()," ], devCards: [ ").concat(e.devCards.toLog()," ], vps: ").concat(e.victoryPoints," cities: ").concat(e.cities," settlements: ").concat(e.settlements," roads: ").concat(e.roads)},this.resources=new o.default,this.rates=new o.default(r.BANK_RATE),this.devCards=new n.default,this.knightsPlayed=0,this.victoryPoints=0,this.cities=r.NUM_CITIES,this.settlements=r.NUM_SETTLEMENTS,this.roads=r.NUM_ROADS}),e("default",i)}}})),System.register("game/turn_fsm",["game/action"],(function(e,t){"use strict";var r,n,o;return t&&t.id,{setters:[function(e){r=e}],execute:function(){!function(e){e.SetupSettlement="Setup Settlement",e.SetupRoad="Setup Road",e.Preroll="Pre-roll",e.Postroll="Post-roll",e.MovingRobber="Moving Robber",e.Robbing="Robbing",e.SelectingMonopolyResource="Selecting Monopoly Resource",e.SelectingYearOfPlentyResources="Selecting Year of Plenty Resource",e.Discarding="Discarding"}(n||(n={})),e("TurnState",n),e("isValidTransition",o=function(e,t){return function(){switch(e){case n.SetupSettlement:return[r.ActionType.BuildSettlement];case n.SetupRoad:return[r.ActionType.BuildRoad];case n.Preroll:return[r.ActionType.PlayMonopoly,r.ActionType.PlayRobber,r.ActionType.PlayYearOfPlenty,r.ActionType.Roll];case n.MovingRobber:return[r.ActionType.MoveRobber];case n.Robbing:return[r.ActionType.Rob];case n.SelectingMonopolyResource:return[r.ActionType.SelectMonopolyResource];case n.SelectingYearOfPlentyResources:return[r.ActionType.SelectYearOfPlentyResources];case n.Discarding:return[r.ActionType.Discard];default:return[r.ActionType.EndTurn]}}().includes(t.type)}),e("default",o)}}})),System.register("game/board/port",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){e("default",(function(e,t){this.resources=e,this.rate=t}))}}})),System.register("game/board/node",[],(function(e,t){"use strict";var r;return t&&t.id,{setters:[],execute:function(){r=function(){function e(){var e=this;this.player=-1,this.city=!1,this.port=null,this.isEmpty=function(){return-1===e.player},this.getPort=function(){return e.port},this.getPlayer=function(){return e.player},this.hasCity=function(){return e.city},this.toLog=function(){return e.isEmpty()?"(_, empty)":"(".concat(e.player,", ").concat(e.city?"city":"set",")")}}return e.prototype.buildSettlement=function(e){-1===this.player&&(this.player=e)},e.prototype.buildCity=function(){-1!==this.player&&(this.city=!0)},e.prototype.setPort=function(e){null===this.port&&(this.port=e)},e}(),e("Node",r),e("default",r)}}})),System.register("game/board/tile",["game/resource/resource"],(function(e,t){"use strict";var r,n;return t&&t.id,{setters:[function(e){r=e}],execute:function(){n=function(){function e(e,t){var n=this;this.number=-1,this.getNumber=function(){return n.number},this.toLog=function(){return"(".concat(n.number,", ").concat(r.resStr(n.resource),")")},this.resource=e,this.nodes=t}return e.prototype.setNumber=function(e){-1===this.number&&(this.number=e)},e.prototype.isAdjacentTo=function(e){for(var t=0;t<this.nodes.length;t++)if(e.nodes.includes(this.nodes[t]))return!0;return!1},e}(),e("Tile",n),e("default",n)}}})),System.register("game/board/board",["game/constants","game/board/node","game/board/tile","game/utils","game/board/graph","game/board/port","game/resource/resource"],(function(e,t){"use strict";var r,i,a,s,u,c,d,l;return t&&t.id,{setters:[function(e){r=e},function(e){i=e},function(e){a=e},function(e){s=e},function(e){u=e},function(e){c=e},function(e){d=e}],execute:function(){l=function(){function e(){var e=this;this.robber=-1,this.adjacentTo=function(t){return e.roadnetwork.children(t)},this.toLog=function(){for(var t="tiles: [ "+e.tiles.map((function(e,t){return"id: ".concat(t," | ").concat(d.resStr(e.resource)," | ").concat(e.getNumber())})).join(", ")+" ]\nnodes: [ ",r=0;r<e.nodes.length;r++)e.nodes[r].isEmpty()||(t+="id: ".concat(r," | ").concat(e.nodes[r].getPlayer()," | ").concat(e.nodes[r].hasCity()?"city":"settlement",", "));return t+" ]\nrobber: ".concat(e.robber)},this.roadnetwork=this.generateRoadNetwork(),this.nodes=this.generateNodes(),this.tiles=this.generateTiles()}return e.prototype.generateRoadNetwork=function(){for(var e=new u.default(o([],n(Array(r.NUM_NODES)),!1).map((function(e,t){return t}))),t=[7,9,11,11,9,7],i=[8,10,11,10,8],a=0,s=0,c=0;c<r.NUM_NODES;c++)a+1!==t[s]&&e.addEdge(c,c+1),s<3&&a%2==0?e.addEdge(c,c+i[s]):3!=s&&4!=s||a%2!=1||e.addEdge(c,c+i[s]),++a==t[s]&&(a=0,s++);return e},e.prototype.generateNodes=function(){var e=o([],n(Array(r.NUM_NODES)),!1).map((function(){return new i.default})),t=o([],n(Array(r.NUM_RESOURCE_TYPES+1)),!1).map((function(){return 1}));t[r.NUM_RESOURCE_TYPES]=4;for(var a=0;a<r.HAVE_PORTS.length;a++){var u=n(r.HAVE_PORTS[a],2),d=u[0],l=u[1],f=s.weightedRandom(t);t[f]--;var h;h=f===r.NUM_RESOURCE_TYPES?new c.default(o([],n(Array(r.NUM_RESOURCE_TYPES).keys()),!1),3):new c.default([f],2),e[d].setPort(h),e[l].setPort(h)}return e},e.prototype.generateTiles=function(){for(var e=new Array(r.NUM_TILES),t=o(o([],n(r.NUM_EACH_RESOURCE_TILE),!1),[1],!1),i=[3,4,5,4,3],u=[0,7,16,28,39],c=[8,10,11,10,8],l=0,f=0,h=0;h<r.NUM_TILES;h++){t[b=s.weightedRandom(t)]--;var y=2*f+u[l],p=y+c[l],g=[y,y+1,y+2,p,p+1,p+2];e[h]=new a.default(b,g),++f==i[l]&&(f=0,l++)}var R=[1,2,2,2,2],v=o(o(o([],n(R),!1),[0],!1),n(R.reverse()),!1),S=o([],n(Array(r.NUM_TILES).keys()),!1).map((function(t){return e[t].resource!==d.default.None?1:0}));for(h=0;h<4;h++){var b=s.weightedRandom(S),m=v[4]>0?6:8;e[b].setNumber(m),v[m-2]--;for(var P=0;P<S.length;P++)1===S[P]&&e[b].isAdjacentTo(e[P])&&(S[P]=0)}for(h=0;h<r.NUM_TILES;h++)-1===e[h].getNumber()&&(b=e[h].resource!==d.default.None?s.weightedRandom(v):5,e[h].setNumber(b+2),e[h].resource===d.default.None?this.robber=h:v[b]--);return e},e.prototype.longestRoadOn=function(e){for(var t=[],r=e.nodes(),i=0;i<r.length;i++)e.degree(r[i])%2==1&&t.push(r[i]);return t.length<=2?e.edgeCount():Math.max.apply(Math,o([],n(t.map((function(t){return s.maxTrail(e,t)}))),!1))},e.prototype.getLongestRoad=function(e){for(var t=this,i=[],a=function(t){var r=c.nodes[t];c.roadnetwork.getWeight(t,t+1)===e&&(r.isEmpty()||r.getPlayer()===e?c.nodes[t+1].isEmpty()||c.nodes[t+1].getPlayer()===e?i.push(["".concat(t),"".concat(t+1)]):i.push(["".concat(t),"".concat(t+1,"_r")]):i.push(["".concat(t,"_l"),"".concat(t+1)]));var n=c.roadnetwork.children(t).filter((function(e){return e>t+1}))[0];void 0!==n&&c.roadnetwork.getWeight(t,n)===e&&(r.isEmpty()||r.getPlayer()===e?c.nodes[n].isEmpty()||c.nodes[n].getPlayer()===e?i.push(["".concat(t),"".concat(n)]):i.push(["".concat(t),"".concat(n,"_d")]):i.push(["".concat(t,"_u"),"".concat(n)]))},c=this,d=0;d<r.NUM_NODES;d++)a(d);var l=s.connectedComponents(new u.default(i));return Math.max.apply(Math,o([0],n(l.map((function(e){return t.longestRoadOn(e)}))),!1))},e.prototype.playersOnRobber=function(){var e=this;return-1!==this.robber?o([],n(new Set(this.tiles[this.robber].nodes.filter((function(t){return!e.nodes[t].isEmpty()})).map((function(t){return e.nodes[t].getPlayer()})))),!1):[]},e.prototype.buildRoad=function(e,t,r){this.roadnetwork.setWeight(e,t,r)},e.prototype.getRoad=function(e,t){return this.roadnetwork.getWeight(e,t)},e}(),e("Board",l),e("default",l)}}})),System.register("game/game",["game/constants","game/player","game/resource/resource_bundle","game/action","game/turn_fsm","game/utils","game/dev_card/dev_card_bundle","game/board/board","game/dev_card/dev_card","game/trade_offer"],(function(e,t){"use strict";var r,i,a,s,u,c,d,l,f,h,y,p;return t&&t.id,{setters:[function(e){r=e},function(e){i=e},function(e){a=e},function(e){s=e},function(e){u=e},function(e){c=e},function(e){d=e},function(e){l=e},function(e){f=e},function(e){h=e}],execute:function(){!function(e){e.SetupForward="Forward Setup",e.SetupBackward="Backward Setup",e.Playing="Playing",e.Finished="Finished"}(y||(y={})),e("GamePhase",y),p=function(){function e(){var e=this;this.currPlayer=function(){return e.players[e.turn]},this.toLog=function(){var t="";t+=e.board.toLog()+"\n",t+="lastRoll: "+e.lastRoll+" | phase: "+e.phase+" | turnState: "+e.turnState+" | turn: "+e.turn+"\n",t+="Players: \n";for(var n=0;n<r.NUM_PLAYERS;n++)t+=e.players[n].toLog()+"\n";return t+="Bank: "+e.bank.toLog()+"\n",t+="Deck: "+e.deck.toLog()+"\n",t+="Largest Army: "+JSON.stringify(e.largestArmy)+"\n",t+="Longest Road: "+JSON.stringify(e.longestRoad)+"\n",t+="Free Roads: "+e.freeRoads+" | hasRolled: "+e.hasRolled+" | winner: "+e.winner+"\n",e.mustDiscard.includes(!0)&&(t+="mustDiscard: "+e.mustDiscard.toString()+"\n"),t},this.bank=new a.default(r.NUM_EACH_RESOURCE),this.deck=new d.default([r.NUM_KNIGHTS,r.NUM_VPS,r.NUM_YEAR_OF_PLENTY,r.NUM_MONOPOLY,r.NUM_ROAD_BUILDING]),this.board=new l.default,this.turn=0,this.players=o([],n(Array(r.NUM_PLAYERS)),!1).map((function(){return new i.default})),this.tradeOffers=[],this.freeRoads=0,this.hasRolled=!1,this.phase=y.SetupForward,this.winner=-1,this.lastRoll=-1,this.turnState=u.TurnState.SetupSettlement,this.mustDiscard=o([],n(Array(r.NUM_PLAYERS)),!1).map((function(){return!1})),this.largestArmy={owner:-1,size:r.MIN_LARGEST_ARMY-1},this.longestRoad={owner:-1,length:r.MIN_LONGEST_ROAD-1}}return e.prototype.transferLongestRoad=function(e,t){-1!==this.longestRoad.owner&&(this.players[this.longestRoad.owner].victoryPoints-=2),this.longestRoad={owner:e,length:t},this.players[e].victoryPoints+=2},e.prototype.checkWinner=function(){for(var e=0;e<r.NUM_PLAYERS;e++)if(this.players[e].victoryPoints>=r.VPS_TO_WIN)return this.phase=y.Finished,void(this.winner=e)},e.prototype.do_roll=function(e){var t=this,i=e.payload.value;if(this.lastRoll=i,7!==i){for(var s=o([],n(Array(r.NUM_PLAYERS)),!1).map((function(){return new a.default})),c=this.board.tiles.filter((function(e,r){return t.board.robber!==r&&e.getNumber()===i})),d=0;d<c.length;d++)for(var l=c[d],f=0;f<l.nodes.length;f++){var h=this.board.nodes[l.nodes[f]];h.isEmpty()||s[h.getPlayer()].add(l.resource,h.hasCity()?2:1)}var y=function(e){for(var t=0,r=0;r<s.length;r++)t+=s[r].get(e);t>p.bank.get(e)&&s.forEach((function(t){return t.removeAll(e)}))},p=this;for(d=0;d<r.NUM_RESOURCE_TYPES;d++)y(d);for(d=0;d<s.length;d++)this.players[d].resources.add(s[d]);this.turnState=u.TurnState.Postroll}else this.mustDiscard=this.players.map((function(e){return e.resources.size()>r.ROBBER_LIMIT})),this.turnState=this.mustDiscard.includes(!0)?u.TurnState.Discarding:u.TurnState.MovingRobber;this.hasRolled=!0},e.prototype.do_buildSettlement=function(e){var t=this,n=e.payload.node;if(this.phase===y.Playing){if(this.board.nodes[n].buildSettlement(this.turn),this.currPlayer().resources.subtract(a.default.settlementCost),this.longestRoad.owner!==this.turn)for(var o=0;o<r.NUM_PLAYERS;o++){var i=this.board.getLongestRoad(o);i>this.longestRoad.length&&this.transferLongestRoad(o,i)}this.checkWinner()}else this.board.nodes[n].buildSettlement(this.turn),this.phase===y.SetupBackward&&this.board.tiles.filter((function(e){return e.nodes.includes(n)})).forEach((function(e){var r=e.resource;return t.currPlayer().resources.add(r,1)})),this.turnState=u.TurnState.SetupRoad;var s=this.board.nodes[n].getPort();if(null!==s){var c=this.currPlayer().rates;for(o=0;o<s.resources.length;o++){var d=s.resources[o];c.set(d,Math.min(c.get(d),s.rate))}}this.currPlayer().victoryPoints++,this.currPlayer().settlements--},e.prototype.do_buildRoad=function(e){var t=e.payload,n=t.node0,o=t.node1;if(this.currPlayer().roads--,this.phase===y.Playing){this.board.buildRoad(n,o,this.turn),0===this.freeRoads?this.currPlayer().resources.subtract(a.default.roadCost):this.freeRoads--;var i=this.longestRoad,s=i.owner,c=i.length;if(s!==this.turn){var d=this.board.getLongestRoad(this.turn);d>c&&(this.transferLongestRoad(this.turn,d),this.checkWinner())}}else this.board.buildRoad(n,o,this.turn),this.phase===y.SetupForward?(this.turn===r.NUM_PLAYERS-1?this.phase=y.SetupBackward:this.turn++,this.turnState=u.TurnState.SetupSettlement):0===this.turn?(this.phase=y.Playing,this.turnState=u.TurnState.Preroll):(this.turn--,this.turnState=u.TurnState.SetupSettlement)},e.prototype.do_buildCity=function(e){var t=e.payload.node;this.board.nodes[t].buildCity(),this.currPlayer().resources.subtract(a.default.cityCost),this.currPlayer().victoryPoints++,this.currPlayer().cities--,this.checkWinner()},e.prototype.do_playRobber=function(){this.currPlayer().devCards.remove(f.default.Knight),this.currPlayer().knightsPlayed++;var e=this.largestArmy,t=e.owner,r=e.size;t!==this.turn&&this.currPlayer().knightsPlayed>r&&(-1!==t&&(this.players[t].victoryPoints-=2),this.currPlayer().victoryPoints+=2,this.largestArmy={owner:this.turn,size:this.currPlayer().knightsPlayed},this.checkWinner()),this.turnState=u.TurnState.MovingRobber},e.prototype.do_moveRobber=function(e){var t=this,r=e.payload.to;this.board.robber=r,void 0!==this.board.playersOnRobber().find((function(e){return e!==t.turn}))?this.turnState=u.TurnState.Robbing:this.turnState=this.hasRolled?u.TurnState.Postroll:u.TurnState.Preroll},e.prototype.do_Rob=function(e){var t=e.payload.victim,r=this.players[t].resources.removeOneAtRandom();this.currPlayer().resources.add(r,1),this.turnState=this.hasRolled?u.TurnState.Postroll:u.TurnState.Preroll},e.prototype.do_playMonopoly=function(){this.currPlayer().devCards.remove(f.default.Monopoly),this.turnState=u.TurnState.SelectingMonopolyResource},e.prototype.do_selectMonopolyResource=function(e){for(var t=e.payload.resource,n=0;n<r.NUM_PLAYERS;n++)if(n!==this.turn){var o=this.players[n].resources.removeAll(t);this.currPlayer().resources.add(t,o)}this.turnState=this.hasRolled?u.TurnState.Postroll:u.TurnState.Preroll},e.prototype.do_playYearOfPlenty=function(){this.currPlayer().devCards.remove(f.default.YearOfPlenty),this.turnState=u.TurnState.SelectingYearOfPlentyResources},e.prototype.do_selectYearOfPlentyResources=function(e){e.payload.resources;for(var t=0;t<2;t++)this.currPlayer().resources.add(t,1),this.bank.subtract(t,1);this.turnState=this.hasRolled?u.TurnState.Postroll:u.TurnState.Preroll},e.prototype.do_playRoadBuilder=function(){this.currPlayer().devCards.remove(f.default.RoadBuilder),this.freeRoads=2,this.turnState=this.hasRolled?u.TurnState.Preroll:u.TurnState.Postroll},e.prototype.do_discard=function(e){var t=e.payload.bundle;this.players[e.player].resources.subtract(t),this.mustDiscard[e.player]=!1,this.turnState=this.mustDiscard.includes(!0)?u.TurnState.Discarding:u.TurnState.MovingRobber},e.prototype.do_drawDevCard=function(e){var t=e.payload.card;this.currPlayer().devCards.add(t),this.deck.remove(t),t===f.default.VictoryPoint&&(this.currPlayer().victoryPoints++,this.checkWinner())},e.prototype.do_exchange=function(e){var t=e.payload,r=t.offer,n=t.request,o=this.currPlayer().rates.get(r);this.bank.add(r,o),this.bank.subtract(n,1),this.currPlayer().resources.add(n,1)},e.prototype.do_makeTradeOffer=function(e){var t=e.payload,r=t.offer,n=t.request,o=this.tradeOffers.length>0?this.tradeOffers[this.tradeOffers.length-1].id+1:0;this.tradeOffers.push(new h.default(o,e.player,r,n))},e.prototype.do_decideOnTradeOffer=function(e){var t=e.payload,r=t.status,n=t.withPlayer,o=t.id,i=this.tradeOffers.findIndex((function(e){return e.id===o})),s=this.tradeOffers[i];s.offerer===e.player?r===h.TradeStatus.Decline?this.tradeOffers.splice(i,1):void 0!==n&&(a.default.trade(s.request,this.players[n].resources,s.offer,this.players[e.player].resources),this.tradeOffers.splice(i,1)):(s.status[e.player]=r,r===h.TradeStatus.Decline&&s.allDeclined()&&this.tradeOffers.splice(i,1))},e.prototype.do_endTurn=function(){this.freeRoads=0,this.turn=(this.turn+1)%r.NUM_PLAYERS,this.hasRolled=!1,this.turnState=u.TurnState.Preroll,this.tradeOffers=[]},e.prototype.doAction=function(e){var t=e.type;t===s.ActionType.Roll?this.do_roll(e):t===s.ActionType.PlayRobber?this.do_playRobber():t===s.ActionType.MoveRobber?this.do_moveRobber(e):t===s.ActionType.Rob?this.do_Rob(e):t===s.ActionType.PlayMonopoly?this.do_playMonopoly():t===s.ActionType.SelectMonopolyResource?this.do_selectMonopolyResource(e):t===s.ActionType.PlayYearOfPlenty?this.do_playYearOfPlenty():t===s.ActionType.SelectYearOfPlentyResources?this.do_selectYearOfPlentyResources(e):t===s.ActionType.PlayRoadBuilder?this.do_playRoadBuilder():t===s.ActionType.BuildSettlement?this.do_buildSettlement(e):t===s.ActionType.BuildCity?this.do_buildCity(e):t===s.ActionType.BuildRoad?this.do_buildRoad(e):t===s.ActionType.Discard?this.do_discard(e):t===s.ActionType.MakeTradeOffer?this.do_makeTradeOffer(e):t===s.ActionType.DecideOnTradeOffer?this.do_decideOnTradeOffer(e):t===s.ActionType.DrawDevCard?this.do_drawDevCard(e):t===s.ActionType.Exchange?this.do_exchange(e):this.do_endTurn()},e.prototype.isValidAction=function(e){var t=this;if(e.player!=this.turn&&(this.turnState===u.TurnState.Preroll||![s.ActionType.Discard,s.ActionType.MakeTradeOffer,s.ActionType.DecideOnTradeOffer].includes(e.type)))return!1;if(!u.default(this.turnState,e))return!1;var o,i=e.type,c=e.payload,d=e.player;if(i===s.ActionType.Roll){var l=c.value;return void 0===l||l>0&&l<13}if(i===s.ActionType.PlayRobber)return this.currPlayer().devCards.has(f.default.Knight);if(i===s.ActionType.MoveRobber){var h=c.to;return h>-1&&h<r.NUM_TILES&&h!==this.board.robber}if(i===s.ActionType.Rob){var p=c.victim,g=this.board.tiles[this.board.robber].nodes.map((function(e){return t.board.nodes[e].getPlayer()}));return-1!==p&&p!==d&&g.includes(p)}if(i===s.ActionType.PlayMonopoly)return this.currPlayer().devCards.has(f.default.Monopoly);if(i===s.ActionType.PlayYearOfPlenty)return this.currPlayer().devCards.has(f.default.YearOfPlenty);if(i===s.ActionType.SelectYearOfPlentyResources){var R=n(c.resources,2),v=R[0],S=R[1];return this.bank.get(v)>1&&this.bank.get(S)>1}if(i===s.ActionType.PlayRoadBuilder)return this.currPlayer().devCards.has(f.default.RoadBuilder);if(i===s.ActionType.BuildSettlement)return(o=c.node)>-1&&o<r.NUM_TILES&&this.board.nodes[o].isEmpty()&&void 0===this.board.adjacentTo(o).find((function(e){return!t.board.nodes[e].isEmpty()}))&&(this.phase!==y.Playing||this.currPlayer().resources.has(a.default.settlementCost));if(i===s.ActionType.BuildCity)return(o=c.node)>-1&&o<r.NUM_TILES&&this.board.nodes[o].getPlayer()===this.turn&&!this.board.nodes[o].hasCity()&&this.currPlayer().resources.has(a.default.cityCost);if(i===s.ActionType.BuildRoad){var b=c,m=b.node0,P=b.node1;if(!(m>-1&&P>-1&&m<r.NUM_NODES&&P<r.NUM_NODES))return!1;var _=this.board.adjacentTo(m),T=this.board.adjacentTo(P);return _.includes(P)&&-1===this.board.getRoad(m,P)&&(this.phase!==y.Playing||this.currPlayer().resources.has(a.default.roadCost))&&(this.board.nodes[m].getPlayer()===this.turn||this.board.nodes[P].getPlayer()===this.turn||void 0!==_.find((function(e){return t.board.getRoad(e,m)===t.turn}))||void 0!==T.find((function(e){return t.board.getRoad(e,P)===t.turn})))}if(i===s.ActionType.Discard){var E=c.bundle;return this.mustDiscard[d]&&this.players[d].resources.has(E)&&E.size()===Math.floor(this.players[d].resources.size()/2)}if(i===s.ActionType.MakeTradeOffer){var O=c.offer;return this.players[d].resources.has(O)}if(i===s.ActionType.DecideOnTradeOffer){var A=c,M=(A.status,A.id),N=(A.withPlayer,this.tradeOffers.find((function(e){return e.id===M})));return void 0!==N}if(i===s.ActionType.DrawDevCard){var w=c.card;return!this.deck.isEmpty()&&(void 0===w||this.deck.has(w))}if(i===s.ActionType.Exchange){var k=c,D=(O=k.offer,k.request),C=this.currPlayer().rates.get(O);return this.currPlayer().resources.get(O)>=C&&this.bank.get(D)>1}return!0},e.prototype.handleAction=function(e){if(!this.isValidAction(e))return null;if(e.type===s.ActionType.Roll)void 0===(t=e.payload).value&&(t.value=c.rollDie()+c.rollDie());else if(e.type===s.ActionType.DrawDevCard){var t;void 0===(t=e.payload).card&&(t.card=this.deck.pickOneAtRandom())}return this.doAction(e),e},e}(),e("Game",p),e("default",p)}}})),System.register("cli",["game/action","game/game","game/resource/resource_bundle"],(function(e,t){"use strict";var n,o,i,a,s,u,c,d,l;return t&&t.id,{setters:[function(e){o=e},function(e){i=e},function(e){a=e}],execute:function(){n=r(521),s=new i.default,u=n.createInterface({input:process.stdin,output:process.stdout}),c=function(e){var t=e.split(" "),r=parseInt(t[0]);switch(r){case o.ActionType.Exchange:return new o.default(r,s.turn,{offer:t[1],request:t[2]});case o.ActionType.MakeTradeOffer:return new o.default(r,s.turn,{offer:new a.default(t.slice(1,6).map(parseInt)),request:new a.default(t.slice(6).map(parseInt))});case o.ActionType.DecideOnTradeOffer:return new o.default(r,s.turn,{status:parseInt(t[1]),id:parseInt(t[2]),withPlayer:t[3]?parseInt(t[3]):void 0});case o.ActionType.Discard:return new o.default(r,s.turn,{bundle:new a.default(t.slice(1,6).map(parseInt))});case o.ActionType.MoveRobber:return new o.default(r,s.turn,{to:parseInt(t[1])});case o.ActionType.Rob:return new o.default(r,s.turn,{victim:parseInt(t[1])});case o.ActionType.SelectMonopolyResource:return new o.default(r,s.turn,{resource:parseInt(t[1])});case o.ActionType.SelectYearOfPlentyResources:return new o.default(r,s.turn,{resources:[parseInt(t[1]),parseInt(t[2])]});case o.ActionType.BuildCity:case o.ActionType.BuildSettlement:return new o.default(r,s.turn,{node:parseInt(t[1])});case o.ActionType.BuildRoad:return new o.default(r,s.turn,{node0:parseInt(t[1]),node1:parseInt(t[2])});default:return new o.default(r,s.turn)}},d="";for(var e=0;e<18;e++)d+="".concat(e,": ").concat(o.actionTypeStr(e),", ");l="$ ",u.on("line",(function(e){null===s.handleAction(c(e))?(console.log("action failed."),process.stdout.write(l)):(console.clear(),console.log(s.toLog()),console.log(d),process.stdout.write(l))})),console.clear(),console.log(s.toLog()),console.log(d),process.stdout.write(l)}}}))},521:e=>{"use strict";e.exports=require("readline")}},t={};!function r(n){var o=t[n];if(void 0!==o)return o.exports;var i=t[n]={exports:{}};return e[n].call(i.exports,i,i.exports,r),i.exports}(562)})();
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2V0dGxlcnMuanMiLCJtYXBwaW5ncyI6IjJxQkFHQSxTQUFZLEdBQ1YsdUJBQ0EsbUNBQ0EsbUNBQ0EsMkJBQ0EsaUNBTEYsQ0FBWSxNQUFPLEssZUFhbkIsZ0JBQTBCLFNBQUMsR0FDekIsT0FBUSxHQUNOLEtBQUssRUFBUSxPQUNYLE1BQU8sU0FDVCxLQUFLLEVBQVEsYUFDWCxNQUFPLGdCQUNULEtBQUssRUFBUSxhQUNYLE1BQU8sTUFDVCxLQUFLLEVBQVEsU0FDWCxNQUFPLFdBQ1QsUUFDRSxNQUFPLG1CLFlBSUUsUSx1a2dDQy9CZkEsRUFBT0MsUUFBVUMsUUFBUSxjQ0NyQkMsRUFBMkIsSUFHL0IsU0FBU0MsRUFBb0JDLEdBRTVCLElBQUlDLEVBQWVILEVBQXlCRSxHQUM1QyxRQUFxQkUsSUFBakJELEVBQ0gsT0FBT0EsRUFBYUwsUUFHckIsSUFBSUQsRUFBU0csRUFBeUJFLEdBQVksQ0FHakRKLFFBQVMsSUFPVixPQUhBTyxFQUFvQkgsR0FBVUksS0FBS1QsRUFBT0MsUUFBU0QsRUFBUUEsRUFBT0MsUUFBU0csR0FHcEVKLEVBQU9DLFFDbEJXRyxDQUFvQixNIiwic291cmNlcyI6WyJ3ZWJwYWNrOi8vc2V0dGxlcnMvLi9zcmMvZ2FtZS9nYW1lLnRzIiwid2VicGFjazovL3NldHRsZXJzL2V4dGVybmFsIG5vZGUtY29tbW9uanMgXCJyZWFkbGluZVwiIiwid2VicGFjazovL3NldHRsZXJzL3dlYnBhY2svYm9vdHN0cmFwIiwid2VicGFjazovL3NldHRsZXJzL3dlYnBhY2svc3RhcnR1cCJdLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIFRoZSBmdW5kYW1lbnRhbCBnYW1lIG9iamVjdC4gRGVjbGFyZXMgYW5kIGRlZmluZXMgYSBjbGVhciBwdWJsaWMgaW50ZXJmYWNlIGZvciBpbnRlcmFjdGluZ1xuICogd2l0aCB0aGUgZ2FtZSBhbmQgbWFuYWdlcyBhbGwgdGhlIGxvZ2ljIGludGVybmFsbHkuXG4gKiBAbW9kdWxlXG4gKi9cblxuaW1wb3J0IHtcbiAgTlVNX0VBQ0hfUkVTT1VSQ0UsXG4gIE5VTV9LTklHSFRTLFxuICBOVU1fVlBTLFxuICBOVU1fTU9OT1BPTFksXG4gIE5VTV9QTEFZRVJTLFxuICBOVU1fUk9BRF9CVUlMRElORyxcbiAgTlVNX1lFQVJfT0ZfUExFTlRZLFxuICBOVU1fUkVTT1VSQ0VfVFlQRVMsXG4gIFJPQkJFUl9MSU1JVCxcbiAgTlVNX1RJTEVTLFxuICBOVU1fTk9ERVMsXG4gIE1JTl9MT05HRVNUX1JPQUQsXG4gIE1JTl9MQVJHRVNUX0FSTVksXG4gIFZQU19UT19XSU4sXG59IGZyb20gJy4vY29uc3RhbnRzJ1xuaW1wb3J0IFBsYXllciBmcm9tICcuL3BsYXllcidcbmltcG9ydCBSZXNvdXJjZUJ1bmRsZSBmcm9tICcuL3Jlc291cmNlL3Jlc291cmNlX2J1bmRsZSdcbmltcG9ydCBBY3Rpb24sIHtcbiAgQWN0aW9uVHlwZSxcbiAgQnVpbGRDaXR5UGF5bG9hZCxcbiAgQnVpbGRSb2FkUGF5bG9hZCxcbiAgQnVpbGRTZXR0bGVtZW50UGF5bG9hZCxcbiAgRGlzY2FyZFBheWxvYWQsXG4gIERyYXdEZXZDYXJkUGF5bG9hZCxcbiAgRXhjaGFuZ2VQYXlsb2FkLFxuICBNYWtlVHJhZGVPZmZlclBheWxvYWQsXG4gIE1vdmVSb2JiZXJQYXlsb2FkLFxuICBSb2JQYXlsb2FkLFxuICBSb2xsUGF5bG9hZCxcbiAgU2VsZWN0TW9ub3BvbHlSZXNvdXJjZVBheWxvYWQsXG4gIFNlbGVjdFllYXJPZlBsZW50eVJlc291cmNlc1BheWxvYWQsXG4gIFRyYWRlT2ZmZXJEZWNpc2lvblBheWxvYWQsXG59IGZyb20gJy4vYWN0aW9uJ1xuaW1wb3J0IGlzVmFsaWRUcmFuc2l0aW9uLCB7IFR1cm5TdGF0ZSB9IGZyb20gJy4vdHVybl9mc20nXG5pbXBvcnQgeyByb2xsRGllIH0gZnJvbSAnLi91dGlscydcbmltcG9ydCBEZXZDYXJkQnVuZGxlIGZyb20gJy4vZGV2X2NhcmQvZGV2X2NhcmRfYnVuZGxlJ1xuaW1wb3J0IEJvYXJkIGZyb20gJy4vYm9hcmQvYm9hcmQnXG5pbXBvcnQgUmVzb3VyY2UgZnJvbSAnLi9yZXNvdXJjZS9yZXNvdXJjZSdcbmltcG9ydCBEZXZDYXJkIGZyb20gJy4vZGV2X2NhcmQvZGV2X2NhcmQnXG5pbXBvcnQgVHJhZGVPZmZlciwgeyBUcmFkZVN0YXR1cyB9IGZyb20gJy4vdHJhZGVfb2ZmZXInXG5pbXBvcnQgTG9nZ2FibGUgZnJvbSAnLi9sb2dnYWJsZSdcblxuLyoqXG4gKiBFbnVtIG9mIGdhbWUgcGhhc2VzLlxuICovXG5leHBvcnQgZW51bSBHYW1lUGhhc2Uge1xuICBTZXR1cEZvcndhcmQgPSAnRm9yd2FyZCBTZXR1cCcsXG4gIFNldHVwQmFja3dhcmQgPSAnQmFja3dhcmQgU2V0dXAnLFxuICBQbGF5aW5nID0gJ1BsYXlpbmcnLFxuICBGaW5pc2hlZCA9ICdGaW5pc2hlZCcsXG59XG5cbmV4cG9ydCBjbGFzcyBHYW1lIGltcGxlbWVudHMgTG9nZ2FibGUge1xuICAvKiogQSByZXNvdXJjZSBidW5kbGUgZm9yIHRoZSBiYW5rLiAqL1xuICBwcml2YXRlIGJhbms6IFJlc291cmNlQnVuZGxlXG4gIC8qKiBUaGUgZGV2IGNhcmQgZGVjay4gKi9cbiAgcHJpdmF0ZSBkZWNrOiBEZXZDYXJkQnVuZGxlXG4gIC8qKiBUaGUgYm9hcmQuICovXG4gIHByaXZhdGUgYm9hcmQ6IEJvYXJkXG4gIC8qKiBUaGUgY3VycmVudCB0dXJuIG51bWJlciB0YWtlcyBvbiBhIHZhbHVlIG9mOiBbMCwgTlVNX1BMQVlFUlNdICovXG4gIHB1YmxpYyB0dXJuOiBudW1iZXJcbiAgLyoqIFRoZSBsYXN0IHJvbGwgKi9cbiAgcHJpdmF0ZSBsYXN0Um9sbDogbnVtYmVyXG4gIC8qKiBMaXN0IG9mIHBsYXllciBvYmplY3RzLiBJbmRleGFibGUgYnkgcGxheWVyIG51bWJlci4gKi9cbiAgcHJpdmF0ZSBwbGF5ZXJzOiBQbGF5ZXJbXVxuICAvKiogQSBsaXN0IG9mIG9wZW4gdHJhZGUgb2ZmZXJzIGluIHRoZSBjdXJyZW50IHR1cm4uICovXG4gIHByaXZhdGUgdHJhZGVPZmZlcnM6IFRyYWRlT2ZmZXJbXVxuICAvKiogVGhlIGN1cnJlbnQgcGhhc2Ugb2YgdGhlIGdhbWUuICovXG4gIHByaXZhdGUgcGhhc2U6IEdhbWVQaGFzZVxuICAvKiogVGhlIHdpbm5lci4gKi9cbiAgcHJpdmF0ZSB3aW5uZXI6IG51bWJlclxuICAvKiogVGhlIGN1cnJlbnQgdHVybidzIHN0YXRlLCBpLmUuIFBvc3Ryb2xsLCBwcmVyb2xsLCBldGMuICovXG4gIHByaXZhdGUgdHVyblN0YXRlOiBUdXJuU3RhdGVcbiAgLyoqIFRoZSBudW1iZXIgb2Ygcm9hZHMgdGhlIGN1cnJlbnQgdHVybidzIHBsYXllciBjYW4gcGxhY2UgZm9yIG5vIGNvc3QuICovXG4gIHByaXZhdGUgZnJlZVJvYWRzOiBudW1iZXJcbiAgLyoqIEJvb2xlYW4gbGlzdCBvZiBwbGF5ZXJzIHdobyBzdGlsbCBuZWVkIHRvIHN1Ym1pdCBkaXNjYXJkIGFjdGlvbnMuICovXG4gIHByaXZhdGUgbXVzdERpc2NhcmQ6IGJvb2xlYW5bXVxuICAvKiogQm9vbGVhbiBpbmRpY2F0aW5nIGlmIHdlIGhhdmUgcm9sbGVkIG9uIHRoZSBjdXJyZW50IHR1cm4geWV0LiAqL1xuICBwcml2YXRlIGhhc1JvbGxlZDogYm9vbGVhblxuICAvKiogW293bmVyLCBhbW91bnRdIG9mIGxhcmdlc3QgYXJteS4gKi9cbiAgcHJpdmF0ZSBsYXJnZXN0QXJteTogeyBvd25lcjogbnVtYmVyOyBzaXplOiBudW1iZXIgfVxuICAvKiogW293bmVyLCBsZW5ndGhdIG9mIGxvbmdlc3Qgcm9hZCAqL1xuICBwcml2YXRlIGxvbmdlc3RSb2FkOiB7IG93bmVyOiBudW1iZXI7IGxlbmd0aDogbnVtYmVyIH1cblxuICBjb25zdHJ1Y3RvcigpIHtcbiAgICB0aGlzLmJhbmsgPSBuZXcgUmVzb3VyY2VCdW5kbGUoTlVNX0VBQ0hfUkVTT1VSQ0UpXG4gICAgdGhpcy5kZWNrID0gbmV3IERldkNhcmRCdW5kbGUoW1xuICAgICAgTlVNX0tOSUdIVFMsXG4gICAgICBOVU1fVlBTLFxuICAgICAgTlVNX1lFQVJfT0ZfUExFTlRZLFxuICAgICAgTlVNX01PTk9QT0xZLFxuICAgICAgTlVNX1JPQURfQlVJTERJTkcsXG4gICAgXSlcbiAgICB0aGlzLmJvYXJkID0gbmV3IEJvYXJkKClcbiAgICB0aGlzLnR1cm4gPSAwXG4gICAgdGhpcy5wbGF5ZXJzID0gWy4uLkFycmF5KE5VTV9QTEFZRVJTKV0ubWFwKCgpID0+IG5ldyBQbGF5ZXIoKSlcbiAgICB0aGlzLnRyYWRlT2ZmZXJzID0gW11cbiAgICB0aGlzLmZyZWVSb2FkcyA9IDBcbiAgICB0aGlzLmhhc1JvbGxlZCA9IGZhbHNlXG5cbiAgICB0aGlzLnBoYXNlID0gR2FtZVBoYXNlLlNldHVwRm9yd2FyZFxuICAgIHRoaXMud2lubmVyID0gLTFcbiAgICB0aGlzLmxhc3RSb2xsID0gLTFcblxuICAgIHRoaXMudHVyblN0YXRlID0gVHVyblN0YXRlLlNldHVwU2V0dGxlbWVudFxuICAgIHRoaXMubXVzdERpc2NhcmQgPSBbLi4uQXJyYXkoTlVNX1BMQVlFUlMpXS5tYXAoKCkgPT4gZmFsc2UpXG4gICAgdGhpcy5sYXJnZXN0QXJteSA9IHsgb3duZXI6IC0xLCBzaXplOiBNSU5fTEFSR0VTVF9BUk1ZIC0gMSB9XG4gICAgdGhpcy5sb25nZXN0Um9hZCA9IHsgb3duZXI6IC0xLCBsZW5ndGg6IE1JTl9MT05HRVNUX1JPQUQgLSAxIH1cbiAgfVxuXG4gIHByaXZhdGUgdHJhbnNmZXJMb25nZXN0Um9hZChvd25lcjogbnVtYmVyLCBsZW5ndGg6IG51bWJlcikge1xuICAgIGlmICh0aGlzLmxvbmdlc3RSb2FkLm93bmVyICE9PSAtMSkgdGhpcy5wbGF5ZXJzW3RoaXMubG9uZ2VzdFJvYWQub3duZXJdLnZpY3RvcnlQb2ludHMgLT0gMlxuICAgIHRoaXMubG9uZ2VzdFJvYWQgPSB7IG93bmVyLCBsZW5ndGggfVxuICAgIHRoaXMucGxheWVyc1tvd25lcl0udmljdG9yeVBvaW50cyArPSAyXG4gIH1cblxuICBwcml2YXRlIGNoZWNrV2lubmVyKCkge1xuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgTlVNX1BMQVlFUlM7IGkrKykge1xuICAgICAgaWYgKHRoaXMucGxheWVyc1tpXS52aWN0b3J5UG9pbnRzID49IFZQU19UT19XSU4pIHtcbiAgICAgICAgdGhpcy5waGFzZSA9IEdhbWVQaGFzZS5GaW5pc2hlZFxuICAgICAgICB0aGlzLndpbm5lciA9IGlcbiAgICAgICAgcmV0dXJuXG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBjdXJyUGxheWVyID0gKCkgPT4gdGhpcy5wbGF5ZXJzW3RoaXMudHVybl1cblxuICAvLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09IGRvXyBoZWxwZXIgbWV0aG9kcyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09XG5cbiAgLy8gZG9fIHByZWZpeGVkIGZ1bmN0aW9ucyBhcmUgaGVscGVycyB0byBhY3R1YWxseSBkbyB0aGVpciByZXNwZWN0aXZlIGFjdGlvbnMuXG4gIC8vIHRoZXNlICoqY2hhbmdlKiogZ2FtZSBzdGF0ZS5cblxuICBwcml2YXRlIGRvX3JvbGwoYWN0aW9uOiBBY3Rpb24pIHtcbiAgICBjb25zdCB7IHZhbHVlIH0gPSBhY3Rpb24ucGF5bG9hZCBhcyBSb2xsUGF5bG9hZFxuICAgIHRoaXMubGFzdFJvbGwgPSB2YWx1ZVxuICAgIGlmICh2YWx1ZSAhPT0gNykge1xuICAgICAgLy8gU3RhbmRhcmQgY2FzZS4gSGFuZCBvdXQgcmVzb3VyY2VzLlxuXG4gICAgICAvLyBQcm9kdWN0aW9uIGZvciBlYWNoIHBsYXllci5cbiAgICAgIGNvbnN0IHByb2R1Y3Rpb246IFJlc291cmNlQnVuZGxlW10gPSBbLi4uQXJyYXkoTlVNX1BMQVlFUlMpXS5tYXAoKCkgPT4gbmV3IFJlc291cmNlQnVuZGxlKCkpXG5cbiAgICAgIC8vIEZvciBldmVyeSB0aWxlLCB1cGRhdGUgdGhlIHByb2R1Y3Rpb24gb2YgZWFjaCBwbGF5ZXIuXG4gICAgICBjb25zdCBwcm9kVGlsZXMgPSB0aGlzLmJvYXJkLnRpbGVzLmZpbHRlcihcbiAgICAgICAgKHRpbGUsIGkpID0+IHRoaXMuYm9hcmQucm9iYmVyICE9PSBpICYmIHRpbGUuZ2V0TnVtYmVyKCkgPT09IHZhbHVlXG4gICAgICApXG5cbiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgcHJvZFRpbGVzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgIGNvbnN0IHRpbGUgPSBwcm9kVGlsZXNbaV1cbiAgICAgICAgZm9yIChsZXQgaiA9IDA7IGogPCB0aWxlLm5vZGVzLmxlbmd0aDsgaisrKSB7XG4gICAgICAgICAgY29uc3Qgbm9kZSA9IHRoaXMuYm9hcmQubm9kZXNbdGlsZS5ub2Rlc1tqXV1cbiAgICAgICAgICBpZiAoIW5vZGUuaXNFbXB0eSgpKSB7XG4gICAgICAgICAgICBwcm9kdWN0aW9uW25vZGUuZ2V0UGxheWVyKCldLmFkZCh0aWxlLnJlc291cmNlLCBub2RlLmhhc0NpdHkoKSA/IDIgOiAxKVxuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICAvLyBDaGVjayBpZiB0aGUgYmFuayBoYXMgZW5vdWdoIG9mIGVhY2ggcmVzb3VyY2UuXG4gICAgICBmb3IgKGxldCBpID0gMDsgaSA8IE5VTV9SRVNPVVJDRV9UWVBFUzsgaSsrKSB7XG4gICAgICAgIGxldCBzdW0gPSAwXG4gICAgICAgIGZvciAobGV0IGogPSAwOyBqIDwgcHJvZHVjdGlvbi5sZW5ndGg7IGorKykge1xuICAgICAgICAgIHN1bSArPSBwcm9kdWN0aW9uW2pdLmdldChpIGFzIFJlc291cmNlKVxuICAgICAgICB9XG4gICAgICAgIC8vIElmIHRoZXJlIGlzIG5vdCBlbm91Z2ggb2YgYSByZXNvdXJjZSwgbm9vbmUgZ2V0cyBpdC5cbiAgICAgICAgaWYgKHN1bSA+IHRoaXMuYmFuay5nZXQoaSBhcyBSZXNvdXJjZSkpIHtcbiAgICAgICAgICBwcm9kdWN0aW9uLmZvckVhY2goKGJ1bmRsZSkgPT4gYnVuZGxlLnJlbW92ZUFsbChpIGFzIFJlc291cmNlKSlcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICAvLyBGaW5hbGx5IGRpc3RyaWJ1dGUgdGhlIHByb2R1Y3Rpb24gYnVuZGxlcyB0byB0aGVpciByZXNwZWN0aXZlIHBsYXllcnMuXG4gICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHByb2R1Y3Rpb24ubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgdGhpcy5wbGF5ZXJzW2ldLnJlc291cmNlcy5hZGQocHJvZHVjdGlvbltpXSlcbiAgICAgIH1cblxuICAgICAgdGhpcy50dXJuU3RhdGUgPSBUdXJuU3RhdGUuUG9zdHJvbGxcbiAgICB9IGVsc2Uge1xuICAgICAgLy8gUm9iYmVyIGNhc2UuXG4gICAgICB0aGlzLm11c3REaXNjYXJkID0gdGhpcy5wbGF5ZXJzLm1hcCgoeyByZXNvdXJjZXMgfSkgPT4gcmVzb3VyY2VzLnNpemUoKSA+IFJPQkJFUl9MSU1JVClcblxuICAgICAgLy8gSWYgc29tZW9uZSBpcyBvdmVyIHRoZSBsaW1pdCwgd2UgbW92ZSB0byBkaXNjYXJkaW5nIHN0YXRlIGJlZm9yZSBtb3Zpbmcgcm9iYmVyLlxuICAgICAgLy8gT3RoZXJ3aXNlIHdlIGp1c3QgbW92ZSB0byBtb3Zpbmcgcm9iYmVyIHN0YXRlLlxuICAgICAgdGhpcy50dXJuU3RhdGUgPSB0aGlzLm11c3REaXNjYXJkLmluY2x1ZGVzKHRydWUpXG4gICAgICAgID8gVHVyblN0YXRlLkRpc2NhcmRpbmdcbiAgICAgICAgOiBUdXJuU3RhdGUuTW92aW5nUm9iYmVyXG4gICAgfVxuICAgIHRoaXMuaGFzUm9sbGVkID0gdHJ1ZVxuICB9XG5cbiAgLy8gQnVpbGQgdGhpbmdzLlxuXG4gIHByaXZhdGUgZG9fYnVpbGRTZXR0bGVtZW50KGFjdGlvbjogQWN0aW9uKSB7XG4gICAgY29uc3QgeyBub2RlIH0gPSBhY3Rpb24ucGF5bG9hZCBhcyBCdWlsZFNldHRsZW1lbnRQYXlsb2FkXG4gICAgaWYgKHRoaXMucGhhc2UgPT09IEdhbWVQaGFzZS5QbGF5aW5nKSB7XG4gICAgICB0aGlzLmJvYXJkLm5vZGVzW25vZGVdLmJ1aWxkU2V0dGxlbWVudCh0aGlzLnR1cm4pXG4gICAgICB0aGlzLmN1cnJQbGF5ZXIoKS5yZXNvdXJjZXMuc3VidHJhY3QoUmVzb3VyY2VCdW5kbGUuc2V0dGxlbWVudENvc3QpXG5cbiAgICAgIC8vIElmIHlvdSBkb24ndCBvd24gdGhlIGxvbmdlc3Qgcm9hZCwgd2UgbmVlZCB0byBjaGVjayBpZiB5b3VyIGJ1aWx0IHNldHRsZW1lbnRcbiAgICAgIC8vIGRpc3J1cHRlZCB3aG8gaGFzIHRoZSBsb25nZXN0IHJvYWQuXG4gICAgICBpZiAodGhpcy5sb25nZXN0Um9hZC5vd25lciAhPT0gdGhpcy50dXJuKSB7XG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgTlVNX1BMQVlFUlM7IGkrKykge1xuICAgICAgICAgIGNvbnN0IG15TGVuZ3RoID0gdGhpcy5ib2FyZC5nZXRMb25nZXN0Um9hZChpKVxuICAgICAgICAgIGlmIChteUxlbmd0aCA+IHRoaXMubG9uZ2VzdFJvYWQubGVuZ3RoKSB0aGlzLnRyYW5zZmVyTG9uZ2VzdFJvYWQoaSwgbXlMZW5ndGgpXG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgdGhpcy5jaGVja1dpbm5lcigpXG4gICAgfSBlbHNlIHtcbiAgICAgIC8vIFNldHVwIGNhc2UuIGp1c3QgYnVpbGQgdGhlIHNldHRsZW1lbnQgd2hlcmUgcmVxdWVzdGVkLlxuICAgICAgdGhpcy5ib2FyZC5ub2Rlc1tub2RlXS5idWlsZFNldHRsZW1lbnQodGhpcy50dXJuKVxuICAgICAgLy8gSWYgdGhpcyBpcyBvdXIgc2Vjb25kIHNldHVwIHBoYXNlIHNldHRsZW1lbnQsIGNvbGxlY3QgcmVzb3VyY2VzLlxuICAgICAgaWYgKHRoaXMucGhhc2UgPT09IEdhbWVQaGFzZS5TZXR1cEJhY2t3YXJkKSB7XG4gICAgICAgIHRoaXMuYm9hcmQudGlsZXNcbiAgICAgICAgICAuZmlsdGVyKCh7IG5vZGVzIH0pID0+IG5vZGVzLmluY2x1ZGVzKG5vZGUpKVxuICAgICAgICAgIC5mb3JFYWNoKCh7IHJlc291cmNlIH0pID0+IHRoaXMuY3VyclBsYXllcigpLnJlc291cmNlcy5hZGQocmVzb3VyY2UsIDEpKVxuICAgICAgfVxuICAgICAgdGhpcy50dXJuU3RhdGUgPSBUdXJuU3RhdGUuU2V0dXBSb2FkXG4gICAgfVxuICAgIC8vIFBvc3QgcHJvY2Vzc2luZy5cbiAgICBjb25zdCBwb3J0ID0gdGhpcy5ib2FyZC5ub2Rlc1tub2RlXS5nZXRQb3J0KClcbiAgICBpZiAocG9ydCAhPT0gbnVsbCkge1xuICAgICAgY29uc3QgcHJldlJhdGVzID0gdGhpcy5jdXJyUGxheWVyKCkucmF0ZXNcbiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgcG9ydC5yZXNvdXJjZXMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgY29uc3QgcmVzID0gcG9ydC5yZXNvdXJjZXNbaV0gYXMgUmVzb3VyY2VcbiAgICAgICAgcHJldlJhdGVzLnNldChyZXMsIE1hdGgubWluKHByZXZSYXRlcy5nZXQocmVzKSwgcG9ydC5yYXRlKSlcbiAgICAgIH1cbiAgICB9XG4gICAgdGhpcy5jdXJyUGxheWVyKCkudmljdG9yeVBvaW50cysrXG4gICAgdGhpcy5jdXJyUGxheWVyKCkuc2V0dGxlbWVudHMtLVxuICB9XG5cbiAgcHJpdmF0ZSBkb19idWlsZFJvYWQoYWN0aW9uOiBBY3Rpb24pIHtcbiAgICBjb25zdCB7IG5vZGUwLCBub2RlMSB9ID0gYWN0aW9uLnBheWxvYWQgYXMgQnVpbGRSb2FkUGF5bG9hZFxuICAgIHRoaXMuY3VyclBsYXllcigpLnJvYWRzLS1cbiAgICBpZiAodGhpcy5waGFzZSA9PT0gR2FtZVBoYXNlLlBsYXlpbmcpIHtcbiAgICAgIHRoaXMuYm9hcmQuYnVpbGRSb2FkKG5vZGUwLCBub2RlMSwgdGhpcy50dXJuKVxuICAgICAgaWYgKHRoaXMuZnJlZVJvYWRzID09PSAwKSB7XG4gICAgICAgIHRoaXMuY3VyclBsYXllcigpLnJlc291cmNlcy5zdWJ0cmFjdChSZXNvdXJjZUJ1bmRsZS5yb2FkQ29zdClcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRoaXMuZnJlZVJvYWRzLS1cbiAgICAgIH1cblxuICAgICAgLy8gSWYgeW91IGJ1aWxkIGEgcm9hZCBkdXJpbmcgcGxheSBhbmQgeW91IGRvbid0IGFscmVhZHkgaGF2ZSB0aGUgbG9uZ2VzdCByb2FkLFxuICAgICAgLy8gd2UgbmVlZCBjaGVjayBpZiB5b3Ugbm93IGhhdmUgdGhlIGxvbmdlc3Qgcm9hZC5cbiAgICAgIGNvbnN0IHsgb3duZXIsIGxlbmd0aCB9ID0gdGhpcy5sb25nZXN0Um9hZFxuICAgICAgaWYgKG93bmVyICE9PSB0aGlzLnR1cm4pIHtcbiAgICAgICAgY29uc3QgbXlMZW5ndGggPSB0aGlzLmJvYXJkLmdldExvbmdlc3RSb2FkKHRoaXMudHVybilcbiAgICAgICAgaWYgKG15TGVuZ3RoID4gbGVuZ3RoKSB7XG4gICAgICAgICAgdGhpcy50cmFuc2Zlckxvbmdlc3RSb2FkKHRoaXMudHVybiwgbXlMZW5ndGgpXG4gICAgICAgICAgdGhpcy5jaGVja1dpbm5lcigpXG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgLy8gU2V0dXAgY2FzZS4ganVzdCBidWlsZCB0aGUgcm9hZCB3aGVyZSByZXF1ZXN0ZWQuXG4gICAgICB0aGlzLmJvYXJkLmJ1aWxkUm9hZChub2RlMCwgbm9kZTEsIHRoaXMudHVybilcbiAgICAgIGlmICh0aGlzLnBoYXNlID09PSBHYW1lUGhhc2UuU2V0dXBGb3J3YXJkKSB7XG4gICAgICAgIGlmICh0aGlzLnR1cm4gPT09IE5VTV9QTEFZRVJTIC0gMSkge1xuICAgICAgICAgIHRoaXMucGhhc2UgPSBHYW1lUGhhc2UuU2V0dXBCYWNrd2FyZFxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHRoaXMudHVybisrXG4gICAgICAgIH1cbiAgICAgICAgdGhpcy50dXJuU3RhdGUgPSBUdXJuU3RhdGUuU2V0dXBTZXR0bGVtZW50XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBpZiAodGhpcy50dXJuID09PSAwKSB7XG4gICAgICAgICAgdGhpcy5waGFzZSA9IEdhbWVQaGFzZS5QbGF5aW5nXG4gICAgICAgICAgdGhpcy50dXJuU3RhdGUgPSBUdXJuU3RhdGUuUHJlcm9sbFxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHRoaXMudHVybi0tXG4gICAgICAgICAgdGhpcy50dXJuU3RhdGUgPSBUdXJuU3RhdGUuU2V0dXBTZXR0bGVtZW50XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGRvX2J1aWxkQ2l0eShhY3Rpb246IEFjdGlvbikge1xuICAgIGNvbnN0IHsgbm9kZSB9ID0gYWN0aW9uLnBheWxvYWQgYXMgQnVpbGRDaXR5UGF5bG9hZFxuICAgIHRoaXMuYm9hcmQubm9kZXNbbm9kZV0uYnVpbGRDaXR5KClcbiAgICB0aGlzLmN1cnJQbGF5ZXIoKS5yZXNvdXJjZXMuc3VidHJhY3QoUmVzb3VyY2VCdW5kbGUuY2l0eUNvc3QpXG4gICAgdGhpcy5jdXJyUGxheWVyKCkudmljdG9yeVBvaW50cysrXG4gICAgdGhpcy5jdXJyUGxheWVyKCkuY2l0aWVzLS1cbiAgICB0aGlzLmNoZWNrV2lubmVyKClcbiAgfVxuXG4gIC8vIFBsYXkgZGV2IGNhcmRzLlxuXG4gIHByaXZhdGUgZG9fcGxheVJvYmJlcigpIHtcbiAgICB0aGlzLmN1cnJQbGF5ZXIoKS5kZXZDYXJkcy5yZW1vdmUoRGV2Q2FyZC5LbmlnaHQpXG4gICAgdGhpcy5jdXJyUGxheWVyKCkua25pZ2h0c1BsYXllZCsrXG4gICAgY29uc3QgeyBvd25lciwgc2l6ZSB9ID0gdGhpcy5sYXJnZXN0QXJteVxuICAgIGlmIChvd25lciAhPT0gdGhpcy50dXJuICYmIHRoaXMuY3VyclBsYXllcigpLmtuaWdodHNQbGF5ZWQgPiBzaXplKSB7XG4gICAgICBpZiAob3duZXIgIT09IC0xKSB0aGlzLnBsYXllcnNbb3duZXJdLnZpY3RvcnlQb2ludHMgLT0gMlxuICAgICAgdGhpcy5jdXJyUGxheWVyKCkudmljdG9yeVBvaW50cyArPSAyXG4gICAgICB0aGlzLmxhcmdlc3RBcm15ID0geyBvd25lcjogdGhpcy50dXJuLCBzaXplOiB0aGlzLmN1cnJQbGF5ZXIoKS5rbmlnaHRzUGxheWVkIH1cbiAgICAgIHRoaXMuY2hlY2tXaW5uZXIoKVxuICAgIH1cbiAgICB0aGlzLnR1cm5TdGF0ZSA9IFR1cm5TdGF0ZS5Nb3ZpbmdSb2JiZXJcbiAgfVxuXG4gIHByaXZhdGUgZG9fbW92ZVJvYmJlcihhY3Rpb246IEFjdGlvbikge1xuICAgIGNvbnN0IHsgdG8gfSA9IGFjdGlvbi5wYXlsb2FkIGFzIE1vdmVSb2JiZXJQYXlsb2FkXG4gICAgdGhpcy5ib2FyZC5yb2JiZXIgPSB0b1xuICAgIGlmICh0aGlzLmJvYXJkLnBsYXllcnNPblJvYmJlcigpLmZpbmQoKHApID0+IHAgIT09IHRoaXMudHVybikgIT09IHVuZGVmaW5lZCkge1xuICAgICAgdGhpcy50dXJuU3RhdGUgPSBUdXJuU3RhdGUuUm9iYmluZ1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLnR1cm5TdGF0ZSA9IHRoaXMuaGFzUm9sbGVkID8gVHVyblN0YXRlLlBvc3Ryb2xsIDogVHVyblN0YXRlLlByZXJvbGxcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGRvX1JvYihhY3Rpb246IEFjdGlvbikge1xuICAgIGNvbnN0IHsgdmljdGltIH0gPSBhY3Rpb24ucGF5bG9hZCBhcyBSb2JQYXlsb2FkXG4gICAgY29uc3QgcmVzOiBSZXNvdXJjZSA9IHRoaXMucGxheWVyc1t2aWN0aW1dLnJlc291cmNlcy5yZW1vdmVPbmVBdFJhbmRvbSgpXG4gICAgdGhpcy5jdXJyUGxheWVyKCkucmVzb3VyY2VzLmFkZChyZXMsIDEpXG4gICAgdGhpcy50dXJuU3RhdGUgPSB0aGlzLmhhc1JvbGxlZCA/IFR1cm5TdGF0ZS5Qb3N0cm9sbCA6IFR1cm5TdGF0ZS5QcmVyb2xsXG4gIH1cblxuICBwcml2YXRlIGRvX3BsYXlNb25vcG9seSgpIHtcbiAgICB0aGlzLmN1cnJQbGF5ZXIoKS5kZXZDYXJkcy5yZW1vdmUoRGV2Q2FyZC5Nb25vcG9seSlcbiAgICB0aGlzLnR1cm5TdGF0ZSA9IFR1cm5TdGF0ZS5TZWxlY3RpbmdNb25vcG9seVJlc291cmNlXG4gIH1cblxuICBwcml2YXRlIGRvX3NlbGVjdE1vbm9wb2x5UmVzb3VyY2UoYWN0aW9uOiBBY3Rpb24pIHtcbiAgICBjb25zdCB7IHJlc291cmNlIH0gPSBhY3Rpb24ucGF5bG9hZCBhcyBTZWxlY3RNb25vcG9seVJlc291cmNlUGF5bG9hZFxuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgTlVNX1BMQVlFUlM7IGkrKykge1xuICAgICAgaWYgKGkgPT09IHRoaXMudHVybikgY29udGludWVcbiAgICAgIGNvbnN0IGFtbnQgPSB0aGlzLnBsYXllcnNbaV0ucmVzb3VyY2VzLnJlbW92ZUFsbChyZXNvdXJjZSlcbiAgICAgIHRoaXMuY3VyclBsYXllcigpLnJlc291cmNlcy5hZGQocmVzb3VyY2UsIGFtbnQpXG4gICAgfVxuICAgIHRoaXMudHVyblN0YXRlID0gdGhpcy5oYXNSb2xsZWQgPyBUdXJuU3RhdGUuUG9zdHJvbGwgOiBUdXJuU3RhdGUuUHJlcm9sbFxuICB9XG5cbiAgcHJpdmF0ZSBkb19wbGF5WWVhck9mUGxlbnR5KCkge1xuICAgIHRoaXMuY3VyclBsYXllcigpLmRldkNhcmRzLnJlbW92ZShEZXZDYXJkLlllYXJPZlBsZW50eSlcbiAgICB0aGlzLnR1cm5TdGF0ZSA9IFR1cm5TdGF0ZS5TZWxlY3RpbmdZZWFyT2ZQbGVudHlSZXNvdXJjZXNcbiAgfVxuXG4gIHByaXZhdGUgZG9fc2VsZWN0WWVhck9mUGxlbnR5UmVzb3VyY2VzKGFjdGlvbjogQWN0aW9uKSB7XG4gICAgY29uc3QgeyByZXNvdXJjZXMgfSA9IGFjdGlvbi5wYXlsb2FkIGFzIFNlbGVjdFllYXJPZlBsZW50eVJlc291cmNlc1BheWxvYWRcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IDI7IGkrKykge1xuICAgICAgdGhpcy5jdXJyUGxheWVyKCkucmVzb3VyY2VzLmFkZChpIGFzIFJlc291cmNlLCAxKVxuICAgICAgdGhpcy5iYW5rLnN1YnRyYWN0KGkgYXMgUmVzb3VyY2UsIDEpXG4gICAgfVxuICAgIHRoaXMudHVyblN0YXRlID0gdGhpcy5oYXNSb2xsZWQgPyBUdXJuU3RhdGUuUG9zdHJvbGwgOiBUdXJuU3RhdGUuUHJlcm9sbFxuICB9XG5cbiAgcHJpdmF0ZSBkb19wbGF5Um9hZEJ1aWxkZXIoKSB7XG4gICAgdGhpcy5jdXJyUGxheWVyKCkuZGV2Q2FyZHMucmVtb3ZlKERldkNhcmQuUm9hZEJ1aWxkZXIpXG4gICAgdGhpcy5mcmVlUm9hZHMgPSAyXG4gICAgdGhpcy50dXJuU3RhdGUgPSB0aGlzLmhhc1JvbGxlZCA/IFR1cm5TdGF0ZS5QcmVyb2xsIDogVHVyblN0YXRlLlBvc3Ryb2xsXG4gIH1cblxuICBwcml2YXRlIGRvX2Rpc2NhcmQoYWN0aW9uOiBBY3Rpb24pIHtcbiAgICBjb25zdCB7IGJ1bmRsZSB9ID0gYWN0aW9uLnBheWxvYWQgYXMgRGlzY2FyZFBheWxvYWRcbiAgICB0aGlzLnBsYXllcnNbYWN0aW9uLnBsYXllcl0ucmVzb3VyY2VzLnN1YnRyYWN0KGJ1bmRsZSlcbiAgICB0aGlzLm11c3REaXNjYXJkW2FjdGlvbi5wbGF5ZXJdID0gZmFsc2VcblxuICAgIC8vIElmIHNvbWVvbmUgaXMgb3ZlciB0aGUgbGltaXQsIHdlIG1vdmUgdG8gZGlzY2FyZGluZyBzdGF0ZSBiZWZvcmUgbW92aW5nIHJvYmJlci5cbiAgICAvLyBPdGhlcndpc2Ugd2UganVzdCBtb3ZlIHRvIG1vdmluZyByb2JiZXIgc3RhdGUuXG4gICAgdGhpcy50dXJuU3RhdGUgPSB0aGlzLm11c3REaXNjYXJkLmluY2x1ZGVzKHRydWUpID8gVHVyblN0YXRlLkRpc2NhcmRpbmcgOiBUdXJuU3RhdGUuTW92aW5nUm9iYmVyXG4gIH1cblxuICBwcml2YXRlIGRvX2RyYXdEZXZDYXJkKGFjdGlvbjogQWN0aW9uKSB7XG4gICAgY29uc3QgeyBjYXJkIH0gPSBhY3Rpb24ucGF5bG9hZCBhcyBEcmF3RGV2Q2FyZFBheWxvYWRcbiAgICB0aGlzLmN1cnJQbGF5ZXIoKS5kZXZDYXJkcy5hZGQoY2FyZClcbiAgICB0aGlzLmRlY2sucmVtb3ZlKGNhcmQpXG4gICAgaWYgKGNhcmQgPT09IERldkNhcmQuVmljdG9yeVBvaW50KSB7XG4gICAgICB0aGlzLmN1cnJQbGF5ZXIoKS52aWN0b3J5UG9pbnRzKytcbiAgICAgIHRoaXMuY2hlY2tXaW5uZXIoKVxuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgZG9fZXhjaGFuZ2UoYWN0aW9uOiBBY3Rpb24pIHtcbiAgICBjb25zdCB7IG9mZmVyLCByZXF1ZXN0IH0gPSBhY3Rpb24ucGF5bG9hZCBhcyBFeGNoYW5nZVBheWxvYWRcbiAgICBjb25zdCByYXRlID0gdGhpcy5jdXJyUGxheWVyKCkucmF0ZXMuZ2V0KG9mZmVyKVxuICAgIHRoaXMuYmFuay5hZGQob2ZmZXIsIHJhdGUpXG4gICAgdGhpcy5iYW5rLnN1YnRyYWN0KHJlcXVlc3QsIDEpXG4gICAgdGhpcy5jdXJyUGxheWVyKCkucmVzb3VyY2VzLmFkZChyZXF1ZXN0LCAxKVxuICB9XG5cbiAgLy8gVHJhZGVzXG5cbiAgcHJpdmF0ZSBkb19tYWtlVHJhZGVPZmZlcihhY3Rpb246IEFjdGlvbikge1xuICAgIGNvbnN0IHsgb2ZmZXIsIHJlcXVlc3QgfSA9IGFjdGlvbi5wYXlsb2FkIGFzIE1ha2VUcmFkZU9mZmVyUGF5bG9hZFxuICAgIGNvbnN0IGlkID1cbiAgICAgIHRoaXMudHJhZGVPZmZlcnMubGVuZ3RoID4gMCA/IHRoaXMudHJhZGVPZmZlcnNbdGhpcy50cmFkZU9mZmVycy5sZW5ndGggLSAxXS5pZCArIDEgOiAwXG4gICAgdGhpcy50cmFkZU9mZmVycy5wdXNoKG5ldyBUcmFkZU9mZmVyKGlkLCBhY3Rpb24ucGxheWVyLCBvZmZlciwgcmVxdWVzdCkpXG4gIH1cblxuICBwcml2YXRlIGRvX2RlY2lkZU9uVHJhZGVPZmZlcihhY3Rpb246IEFjdGlvbikge1xuICAgIGNvbnN0IHsgc3RhdHVzLCB3aXRoUGxheWVyLCBpZCB9ID0gYWN0aW9uLnBheWxvYWQgYXMgVHJhZGVPZmZlckRlY2lzaW9uUGF5bG9hZFxuICAgIGNvbnN0IGluZGV4ID0gdGhpcy50cmFkZU9mZmVycy5maW5kSW5kZXgoKHRvKSA9PiB0by5pZCA9PT0gaWQpXG4gICAgY29uc3QgdHJhZGVPZmZlcjogVHJhZGVPZmZlciA9IHRoaXMudHJhZGVPZmZlcnNbaW5kZXhdXG5cbiAgICBpZiAodHJhZGVPZmZlci5vZmZlcmVyID09PSBhY3Rpb24ucGxheWVyKSB7XG4gICAgICBpZiAoc3RhdHVzID09PSBUcmFkZVN0YXR1cy5EZWNsaW5lKSB7XG4gICAgICAgIC8vIENhc2UgMDogQ2xvc2luZyBhIHRyYWRlIG9mZmVyIHdlIG93bi5cbiAgICAgICAgdGhpcy50cmFkZU9mZmVycy5zcGxpY2UoaW5kZXgsIDEpXG4gICAgICB9IGVsc2UgaWYgKHdpdGhQbGF5ZXIgIT09IHVuZGVmaW5lZCkge1xuICAgICAgICAvLyBDYXNlIDE6IFRyYWRpbmcgd2l0aCBhIHBsYXllciB3aG8gYWNjZXB0ZWQgb3VyIG9mZmVyLlxuICAgICAgICBSZXNvdXJjZUJ1bmRsZS50cmFkZShcbiAgICAgICAgICB0cmFkZU9mZmVyLnJlcXVlc3QsXG4gICAgICAgICAgdGhpcy5wbGF5ZXJzW3dpdGhQbGF5ZXJdLnJlc291cmNlcyxcbiAgICAgICAgICB0cmFkZU9mZmVyLm9mZmVyLFxuICAgICAgICAgIHRoaXMucGxheWVyc1thY3Rpb24ucGxheWVyXS5yZXNvdXJjZXNcbiAgICAgICAgKVxuICAgICAgICB0aGlzLnRyYWRlT2ZmZXJzLnNwbGljZShpbmRleCwgMSlcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgLy8gQ2FzZSAyOiBDaGFuZ2Ugb3VyIHN0YXR1cyBvbiBzb21lIG90aGVyIHRyYWRlIG9mZmVyLlxuICAgICAgdHJhZGVPZmZlci5zdGF0dXNbYWN0aW9uLnBsYXllcl0gPSBzdGF0dXNcblxuICAgICAgLy8gSWYgb3VyIGRlY2xpbmF0aW9uIG1lYW5zIGV2ZXJ5b25lIGRlY2xpbmVkLCBkZWxldGUgdGhlIG9mZmVyLlxuICAgICAgaWYgKHN0YXR1cyA9PT0gVHJhZGVTdGF0dXMuRGVjbGluZSAmJiB0cmFkZU9mZmVyLmFsbERlY2xpbmVkKCkpIHtcbiAgICAgICAgdGhpcy50cmFkZU9mZmVycy5zcGxpY2UoaW5kZXgsIDEpXG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBkb19lbmRUdXJuKCkge1xuICAgIHRoaXMuZnJlZVJvYWRzID0gMFxuICAgIHRoaXMudHVybiA9ICh0aGlzLnR1cm4gKyAxKSAlIE5VTV9QTEFZRVJTXG4gICAgdGhpcy5oYXNSb2xsZWQgPSBmYWxzZVxuICAgIHRoaXMudHVyblN0YXRlID0gVHVyblN0YXRlLlByZXJvbGxcbiAgICB0aGlzLnRyYWRlT2ZmZXJzID0gW11cbiAgfVxuXG4gIHByaXZhdGUgZG9BY3Rpb24oYWN0aW9uOiBBY3Rpb24pOiB2b2lkIHtcbiAgICBjb25zdCB7IHR5cGUgfSA9IGFjdGlvblxuICAgIGlmICh0eXBlID09PSBBY3Rpb25UeXBlLlJvbGwpIHtcbiAgICAgIHRoaXMuZG9fcm9sbChhY3Rpb24pXG4gICAgfSBlbHNlIGlmICh0eXBlID09PSBBY3Rpb25UeXBlLlBsYXlSb2JiZXIpIHtcbiAgICAgIHRoaXMuZG9fcGxheVJvYmJlcigpXG4gICAgfSBlbHNlIGlmICh0eXBlID09PSBBY3Rpb25UeXBlLk1vdmVSb2JiZXIpIHtcbiAgICAgIHRoaXMuZG9fbW92ZVJvYmJlcihhY3Rpb24pXG4gICAgfSBlbHNlIGlmICh0eXBlID09PSBBY3Rpb25UeXBlLlJvYikge1xuICAgICAgdGhpcy5kb19Sb2IoYWN0aW9uKVxuICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gQWN0aW9uVHlwZS5QbGF5TW9ub3BvbHkpIHtcbiAgICAgIHRoaXMuZG9fcGxheU1vbm9wb2x5KClcbiAgICB9IGVsc2UgaWYgKHR5cGUgPT09IEFjdGlvblR5cGUuU2VsZWN0TW9ub3BvbHlSZXNvdXJjZSkge1xuICAgICAgdGhpcy5kb19zZWxlY3RNb25vcG9seVJlc291cmNlKGFjdGlvbilcbiAgICB9IGVsc2UgaWYgKHR5cGUgPT09IEFjdGlvblR5cGUuUGxheVllYXJPZlBsZW50eSkge1xuICAgICAgdGhpcy5kb19wbGF5WWVhck9mUGxlbnR5KClcbiAgICB9IGVsc2UgaWYgKHR5cGUgPT09IEFjdGlvblR5cGUuU2VsZWN0WWVhck9mUGxlbnR5UmVzb3VyY2VzKSB7XG4gICAgICB0aGlzLmRvX3NlbGVjdFllYXJPZlBsZW50eVJlc291cmNlcyhhY3Rpb24pXG4gICAgfSBlbHNlIGlmICh0eXBlID09PSBBY3Rpb25UeXBlLlBsYXlSb2FkQnVpbGRlcikge1xuICAgICAgdGhpcy5kb19wbGF5Um9hZEJ1aWxkZXIoKVxuICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gQWN0aW9uVHlwZS5CdWlsZFNldHRsZW1lbnQpIHtcbiAgICAgIHRoaXMuZG9fYnVpbGRTZXR0bGVtZW50KGFjdGlvbilcbiAgICB9IGVsc2UgaWYgKHR5cGUgPT09IEFjdGlvblR5cGUuQnVpbGRDaXR5KSB7XG4gICAgICB0aGlzLmRvX2J1aWxkQ2l0eShhY3Rpb24pXG4gICAgfSBlbHNlIGlmICh0eXBlID09PSBBY3Rpb25UeXBlLkJ1aWxkUm9hZCkge1xuICAgICAgdGhpcy5kb19idWlsZFJvYWQoYWN0aW9uKVxuICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gQWN0aW9uVHlwZS5EaXNjYXJkKSB7XG4gICAgICB0aGlzLmRvX2Rpc2NhcmQoYWN0aW9uKVxuICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gQWN0aW9uVHlwZS5NYWtlVHJhZGVPZmZlcikge1xuICAgICAgdGhpcy5kb19tYWtlVHJhZGVPZmZlcihhY3Rpb24pXG4gICAgfSBlbHNlIGlmICh0eXBlID09PSBBY3Rpb25UeXBlLkRlY2lkZU9uVHJhZGVPZmZlcikge1xuICAgICAgdGhpcy5kb19kZWNpZGVPblRyYWRlT2ZmZXIoYWN0aW9uKVxuICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gQWN0aW9uVHlwZS5EcmF3RGV2Q2FyZCkge1xuICAgICAgdGhpcy5kb19kcmF3RGV2Q2FyZChhY3Rpb24pXG4gICAgfSBlbHNlIGlmICh0eXBlID09PSBBY3Rpb25UeXBlLkV4Y2hhbmdlKSB7XG4gICAgICB0aGlzLmRvX2V4Y2hhbmdlKGFjdGlvbilcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5kb19lbmRUdXJuKClcbiAgICB9XG4gIH1cblxuICAvLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09IFB1YmxpYyBJbnRlcmZhY2UgPT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuXG4gIC8qKlxuICAgKiBDaGVjayBpZiBhbiBhY3Rpb24gaXMgdmFsaWQuXG4gICAqIEBwYXJhbSBhY3Rpb24gVGhlIGFjdGlvbiByZXF1ZXN0ZWQgdG8gYmUgZG9uZVxuICAgKiBAcmV0dXJucyBCb29sZWFuIGluZGljYXRpbmcgaWYgdGhlIGFjdGlvbiBpcyB2YWxpZC5cbiAgICovXG4gIHB1YmxpYyBpc1ZhbGlkQWN0aW9uKGFjdGlvbjogQWN0aW9uKTogYm9vbGVhbiB7XG4gICAgLy8gSXMgdGhpcyBhY3Rpb24gcmVzdHJpY3RlZCBvbmx5IHRvIHRoZSBwbGF5ZXIgb2YgdGhlIGN1cnJlbnQgdHVybj9cbiAgICBpZiAoXG4gICAgICBhY3Rpb24ucGxheWVyICE9IHRoaXMudHVybiAmJlxuICAgICAgKHRoaXMudHVyblN0YXRlID09PSBUdXJuU3RhdGUuUHJlcm9sbCB8fFxuICAgICAgICAhW0FjdGlvblR5cGUuRGlzY2FyZCwgQWN0aW9uVHlwZS5NYWtlVHJhZGVPZmZlciwgQWN0aW9uVHlwZS5EZWNpZGVPblRyYWRlT2ZmZXJdLmluY2x1ZGVzKFxuICAgICAgICAgIGFjdGlvbi50eXBlXG4gICAgICAgICkpXG4gICAgKSB7XG4gICAgICByZXR1cm4gZmFsc2VcbiAgICB9XG4gICAgLy8gSXMgdGhlIHJlcXVlc3RlZCBhY3Rpb24gYW4gYWNjZXB0YWJsZSB0cmFuc2l0aW9uIGdpdmVuXG4gICAgLy8gdGhlIGN1cnJlbnQgYHR1cm5TdGF0ZWA/XG4gICAgaWYgKCFpc1ZhbGlkVHJhbnNpdGlvbih0aGlzLnR1cm5TdGF0ZSwgYWN0aW9uKSkgcmV0dXJuIGZhbHNlXG4gICAgLy8gU28gaWYgdGhlIGFjdGlvbiBpcyBjb3JyZWN0IGdpdmVuIHRoZSBgcGxheWVyYCBhbmQgaXQgaXMgY29ycmVjdCBnaXZlblxuICAgIC8vIHRoZSBzdGF0ZSBvZiB0aGUgdHVybiwgaXMgaXQgdmFsaWQgZ2l2ZW4gdGhlIHJlc3Qgb2YgdGhlIGdhbWUncyBzdGF0ZT9cbiAgICBjb25zdCB7IHR5cGUsIHBheWxvYWQsIHBsYXllciB9ID0gYWN0aW9uXG4gICAgaWYgKHR5cGUgPT09IEFjdGlvblR5cGUuUm9sbCkge1xuICAgICAgY29uc3QgeyB2YWx1ZSB9ID0gcGF5bG9hZCBhcyBSb2xsUGF5bG9hZFxuICAgICAgcmV0dXJuIHZhbHVlID09PSB1bmRlZmluZWQgfHwgKHZhbHVlID4gMCAmJiB2YWx1ZSA8IDEzKVxuICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gQWN0aW9uVHlwZS5QbGF5Um9iYmVyKSB7XG4gICAgICByZXR1cm4gdGhpcy5jdXJyUGxheWVyKCkuZGV2Q2FyZHMuaGFzKERldkNhcmQuS25pZ2h0KVxuICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gQWN0aW9uVHlwZS5Nb3ZlUm9iYmVyKSB7XG4gICAgICBjb25zdCB7IHRvIH0gPSBwYXlsb2FkIGFzIE1vdmVSb2JiZXJQYXlsb2FkXG4gICAgICByZXR1cm4gdG8gPiAtMSAmJiB0byA8IE5VTV9USUxFUyAmJiB0byAhPT0gdGhpcy5ib2FyZC5yb2JiZXJcbiAgICB9IGVsc2UgaWYgKHR5cGUgPT09IEFjdGlvblR5cGUuUm9iKSB7XG4gICAgICBjb25zdCB7IHZpY3RpbSB9ID0gcGF5bG9hZCBhcyBSb2JQYXlsb2FkXG4gICAgICBjb25zdCBzZWxlY3RhYmxlID0gdGhpcy5ib2FyZC50aWxlc1t0aGlzLmJvYXJkLnJvYmJlcl0ubm9kZXMubWFwKChuaWQpID0+XG4gICAgICAgIHRoaXMuYm9hcmQubm9kZXNbbmlkXS5nZXRQbGF5ZXIoKVxuICAgICAgKVxuICAgICAgcmV0dXJuIHZpY3RpbSAhPT0gLTEgJiYgdmljdGltICE9PSBwbGF5ZXIgJiYgc2VsZWN0YWJsZS5pbmNsdWRlcyh2aWN0aW0pXG4gICAgfSBlbHNlIGlmICh0eXBlID09PSBBY3Rpb25UeXBlLlBsYXlNb25vcG9seSkge1xuICAgICAgcmV0dXJuIHRoaXMuY3VyclBsYXllcigpLmRldkNhcmRzLmhhcyhEZXZDYXJkLk1vbm9wb2x5KVxuICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gQWN0aW9uVHlwZS5QbGF5WWVhck9mUGxlbnR5KSB7XG4gICAgICByZXR1cm4gdGhpcy5jdXJyUGxheWVyKCkuZGV2Q2FyZHMuaGFzKERldkNhcmQuWWVhck9mUGxlbnR5KVxuICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gQWN0aW9uVHlwZS5TZWxlY3RZZWFyT2ZQbGVudHlSZXNvdXJjZXMpIHtcbiAgICAgIGNvbnN0IFtyZXMxLCByZXMyXSA9ICg8U2VsZWN0WWVhck9mUGxlbnR5UmVzb3VyY2VzUGF5bG9hZD5wYXlsb2FkKS5yZXNvdXJjZXNcbiAgICAgIHJldHVybiB0aGlzLmJhbmsuZ2V0KHJlczEpID4gMSAmJiB0aGlzLmJhbmsuZ2V0KHJlczIpID4gMVxuICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gQWN0aW9uVHlwZS5QbGF5Um9hZEJ1aWxkZXIpIHtcbiAgICAgIHJldHVybiB0aGlzLmN1cnJQbGF5ZXIoKS5kZXZDYXJkcy5oYXMoRGV2Q2FyZC5Sb2FkQnVpbGRlcilcbiAgICB9IGVsc2UgaWYgKHR5cGUgPT09IEFjdGlvblR5cGUuQnVpbGRTZXR0bGVtZW50KSB7XG4gICAgICBjb25zdCBub2RlOiBudW1iZXIgPSAoPEJ1aWxkU2V0dGxlbWVudFBheWxvYWQ+cGF5bG9hZCkubm9kZVxuICAgICAgcmV0dXJuIChcbiAgICAgICAgbm9kZSA+IC0xICYmXG4gICAgICAgIG5vZGUgPCBOVU1fVElMRVMgJiZcbiAgICAgICAgdGhpcy5ib2FyZC5ub2Rlc1tub2RlXS5pc0VtcHR5KCkgJiZcbiAgICAgICAgdGhpcy5ib2FyZC5hZGphY2VudFRvKG5vZGUpLmZpbmQoKG90aGVyKSA9PiAhdGhpcy5ib2FyZC5ub2Rlc1tvdGhlcl0uaXNFbXB0eSgpKSA9PT1cbiAgICAgICAgICB1bmRlZmluZWQgJiZcbiAgICAgICAgKHRoaXMucGhhc2UgIT09IEdhbWVQaGFzZS5QbGF5aW5nIHx8XG4gICAgICAgICAgdGhpcy5jdXJyUGxheWVyKCkucmVzb3VyY2VzLmhhcyhSZXNvdXJjZUJ1bmRsZS5zZXR0bGVtZW50Q29zdCkpXG4gICAgICApXG4gICAgfSBlbHNlIGlmICh0eXBlID09PSBBY3Rpb25UeXBlLkJ1aWxkQ2l0eSkge1xuICAgICAgY29uc3Qgbm9kZTogbnVtYmVyID0gKDxCdWlsZENpdHlQYXlsb2FkPnBheWxvYWQpLm5vZGVcbiAgICAgIHJldHVybiAoXG4gICAgICAgIG5vZGUgPiAtMSAmJlxuICAgICAgICBub2RlIDwgTlVNX1RJTEVTICYmXG4gICAgICAgIHRoaXMuYm9hcmQubm9kZXNbbm9kZV0uZ2V0UGxheWVyKCkgPT09IHRoaXMudHVybiAmJlxuICAgICAgICAhdGhpcy5ib2FyZC5ub2Rlc1tub2RlXS5oYXNDaXR5KCkgJiZcbiAgICAgICAgdGhpcy5jdXJyUGxheWVyKCkucmVzb3VyY2VzLmhhcyhSZXNvdXJjZUJ1bmRsZS5jaXR5Q29zdClcbiAgICAgIClcbiAgICB9IGVsc2UgaWYgKHR5cGUgPT09IEFjdGlvblR5cGUuQnVpbGRSb2FkKSB7XG4gICAgICBjb25zdCB7IG5vZGUwLCBub2RlMSB9ID0gPEJ1aWxkUm9hZFBheWxvYWQ+cGF5bG9hZFxuICAgICAgY29uc3Qgbm9kZXNWYWxpZCA9IG5vZGUwID4gLTEgJiYgbm9kZTEgPiAtMSAmJiBub2RlMCA8IE5VTV9OT0RFUyAmJiBub2RlMSA8IE5VTV9OT0RFU1xuICAgICAgaWYgKCFub2Rlc1ZhbGlkKSByZXR1cm4gZmFsc2VcbiAgICAgIGNvbnN0IGFkajAgPSB0aGlzLmJvYXJkLmFkamFjZW50VG8obm9kZTApXG4gICAgICBjb25zdCBhZGoxID0gdGhpcy5ib2FyZC5hZGphY2VudFRvKG5vZGUxKVxuICAgICAgcmV0dXJuIChcbiAgICAgICAgYWRqMC5pbmNsdWRlcyhub2RlMSkgJiYgLy8gbm9kZXMgYWRqYWNlbnQgYW5kXG4gICAgICAgIHRoaXMuYm9hcmQuZ2V0Um9hZChub2RlMCwgbm9kZTEpID09PSAtMSAmJiAvLyBubyByb2FkIHRoZXJlIHlldCBhbmRcbiAgICAgICAgKHRoaXMucGhhc2UgIT09IEdhbWVQaGFzZS5QbGF5aW5nIHx8XG4gICAgICAgICAgdGhpcy5jdXJyUGxheWVyKCkucmVzb3VyY2VzLmhhcyhSZXNvdXJjZUJ1bmRsZS5yb2FkQ29zdCkpICYmIC8vIGNhbiBidXkgYSByb2FkIG9yIGl0cyBzZXR1cFxuICAgICAgICAodGhpcy5ib2FyZC5ub2Rlc1tub2RlMF0uZ2V0UGxheWVyKCkgPT09IHRoaXMudHVybiB8fCAvLyBzZXR0bGVtZW50IG9uIG5vZGUgMCBvclxuICAgICAgICAgIHRoaXMuYm9hcmQubm9kZXNbbm9kZTFdLmdldFBsYXllcigpID09PSB0aGlzLnR1cm4gfHwgLy8gc2V0dGxlbWVudCBvbiBub2RlIDEgb3JcbiAgICAgICAgICBhZGowLmZpbmQoKG9uaWQwKSA9PiB0aGlzLmJvYXJkLmdldFJvYWQob25pZDAsIG5vZGUwKSA9PT0gdGhpcy50dXJuKSAhPT0gdW5kZWZpbmVkIHx8IC8vIHJvYWQgd2Ugb3duIGluY2lkZW50IG9uIG5vZGUgMCBvclxuICAgICAgICAgIGFkajEuZmluZCgob25pZDEpID0+IHRoaXMuYm9hcmQuZ2V0Um9hZChvbmlkMSwgbm9kZTEpID09PSB0aGlzLnR1cm4pICE9PSB1bmRlZmluZWQpIC8vIHJvYWQgd2Ugb3duIGluY2lkZW50IG9uIG5vZGUgMVxuICAgICAgKVxuICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gQWN0aW9uVHlwZS5EaXNjYXJkKSB7XG4gICAgICBjb25zdCB7IGJ1bmRsZSB9ID0gcGF5bG9hZCBhcyBEaXNjYXJkUGF5bG9hZFxuICAgICAgcmV0dXJuIChcbiAgICAgICAgdGhpcy5tdXN0RGlzY2FyZFtwbGF5ZXJdICYmXG4gICAgICAgIHRoaXMucGxheWVyc1twbGF5ZXJdLnJlc291cmNlcy5oYXMoYnVuZGxlKSAmJlxuICAgICAgICBidW5kbGUuc2l6ZSgpID09PSBNYXRoLmZsb29yKHRoaXMucGxheWVyc1twbGF5ZXJdLnJlc291cmNlcy5zaXplKCkgLyAyKVxuICAgICAgKVxuICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gQWN0aW9uVHlwZS5NYWtlVHJhZGVPZmZlcikge1xuICAgICAgY29uc3QgeyBvZmZlciB9ID0gcGF5bG9hZCBhcyBNYWtlVHJhZGVPZmZlclBheWxvYWRcbiAgICAgIHJldHVybiB0aGlzLnBsYXllcnNbcGxheWVyXS5yZXNvdXJjZXMuaGFzKG9mZmVyKVxuICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gQWN0aW9uVHlwZS5EZWNpZGVPblRyYWRlT2ZmZXIpIHtcbiAgICAgIGNvbnN0IHsgc3RhdHVzLCBpZCwgd2l0aFBsYXllciB9ID0gcGF5bG9hZCBhcyBUcmFkZU9mZmVyRGVjaXNpb25QYXlsb2FkXG4gICAgICBjb25zdCB0cmFkZU9mZmVyID0gdGhpcy50cmFkZU9mZmVycy5maW5kKChvZmZlcikgPT4gb2ZmZXIuaWQgPT09IGlkKVxuICAgICAgcmV0dXJuIHRyYWRlT2ZmZXIgIT09IHVuZGVmaW5lZCAvLyBUT0RPOiB0aGlzIGxvZ2ljIGlzIGluY29tcGxldGUuXG4gICAgfSBlbHNlIGlmICh0eXBlID09PSBBY3Rpb25UeXBlLkRyYXdEZXZDYXJkKSB7XG4gICAgICBjb25zdCB7IGNhcmQgfSA9IHBheWxvYWQgYXMgRHJhd0RldkNhcmRQYXlsb2FkXG4gICAgICByZXR1cm4gIXRoaXMuZGVjay5pc0VtcHR5KCkgJiYgKGNhcmQgPT09IHVuZGVmaW5lZCB8fCB0aGlzLmRlY2suaGFzKGNhcmQpKVxuICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gQWN0aW9uVHlwZS5FeGNoYW5nZSkge1xuICAgICAgY29uc3QgeyBvZmZlciwgcmVxdWVzdCB9ID0gcGF5bG9hZCBhcyBFeGNoYW5nZVBheWxvYWRcbiAgICAgIGNvbnN0IHJhdGUgPSB0aGlzLmN1cnJQbGF5ZXIoKS5yYXRlcy5nZXQob2ZmZXIpXG4gICAgICByZXR1cm4gdGhpcy5jdXJyUGxheWVyKCkucmVzb3VyY2VzLmdldChvZmZlcikgPj0gcmF0ZSAmJiB0aGlzLmJhbmsuZ2V0KHJlcXVlc3QpID4gMVxuICAgIH1cbiAgICByZXR1cm4gdHJ1ZVxuICB9XG5cbiAgLyoqXG4gICAqICgxKSBDaGVjayBpZiBhbiBhY3Rpb24gaXMgdmFsaWQsICgyKSBtYWtlIGFjdGlvbiBkZXRlcm1pbmlzdGljIChlZGdlIGNhc2VzKSxcbiAgICogdGhlbiAoMykgZG8gdGhlIGFjdGlvbi5cbiAgICogQHBhcmFtIGFjdGlvbiBUaGUgYWN0aW9uIHRvIGJlIGhhbmRsZWQuXG4gICAqIEByZXR1cm5zIGBudWxsYCBpZiBgYWN0aW9uYCBpcyBpbnZhbGlkLCB0aGUgY29tcGxldGVkLCB2YWxpZCBhY3Rpb24gb3RoZXJ3aXNlLlxuICAgKi9cbiAgcHVibGljIGhhbmRsZUFjdGlvbihhY3Rpb246IEFjdGlvbik6IG51bGwgfCBBY3Rpb24ge1xuICAgIC8vIERldGVybWluZSBpZiB0aGUgYWN0aW9uIGNhbiBiZSBkb25lIGdpdmVuIGN1cnJlbnQgZ2FtZSBzdGF0ZS5cbiAgICBpZiAoIXRoaXMuaXNWYWxpZEFjdGlvbihhY3Rpb24pKSByZXR1cm4gbnVsbFxuICAgIC8vIFRoZSB0d28gZWRnZSBjYXNlcyB3aGVyZSB3ZSBuZWVkIHRvIHVwZGF0ZSBvdXIgYWN0aW9uJ3MgcGF5bG9hZCBkdWVcbiAgICAvLyB0byByYW5kb21uZXNzXG4gICAgaWYgKGFjdGlvbi50eXBlID09PSBBY3Rpb25UeXBlLlJvbGwpIHtcbiAgICAgIGNvbnN0IHBheWxvYWQgPSA8Um9sbFBheWxvYWQ+YWN0aW9uLnBheWxvYWRcbiAgICAgIGlmIChwYXlsb2FkLnZhbHVlID09PSB1bmRlZmluZWQpIHBheWxvYWQudmFsdWUgPSByb2xsRGllKCkgKyByb2xsRGllKClcbiAgICB9IGVsc2UgaWYgKGFjdGlvbi50eXBlID09PSBBY3Rpb25UeXBlLkRyYXdEZXZDYXJkKSB7XG4gICAgICBjb25zdCBwYXlsb2FkID0gPERyYXdEZXZDYXJkUGF5bG9hZD5hY3Rpb24ucGF5bG9hZFxuICAgICAgaWYgKHBheWxvYWQuY2FyZCA9PT0gdW5kZWZpbmVkKSBwYXlsb2FkLmNhcmQgPSB0aGlzLmRlY2sucGlja09uZUF0UmFuZG9tKClcbiAgICB9XG5cbiAgICAvLyBTYWZlbHkgdXBkYXRlIGludGVybmFsIHN0YXRlIGJhc2VkIG9uIHRoZSB2YWxpZGF0ZWQgYWN0aW9uLlxuICAgIHRoaXMuZG9BY3Rpb24oYWN0aW9uKVxuXG4gICAgLy8gcmV0dXJuIHRoZSBjb21wbGV0ZWQsIHZhbGlkIGFjdGlvbi5cbiAgICByZXR1cm4gYWN0aW9uXG4gIH1cblxuICB0b0xvZyA9ICgpID0+IHtcbiAgICBsZXQgbyA9ICcnXG4gICAgbyArPSB0aGlzLmJvYXJkLnRvTG9nKCkgKyAnXFxuJ1xuICAgIG8gKz1cbiAgICAgICdsYXN0Um9sbDogJyArXG4gICAgICB0aGlzLmxhc3RSb2xsICtcbiAgICAgICcgfCBwaGFzZTogJyArXG4gICAgICB0aGlzLnBoYXNlICtcbiAgICAgICcgfCB0dXJuU3RhdGU6ICcgK1xuICAgICAgdGhpcy50dXJuU3RhdGUgK1xuICAgICAgJyB8IHR1cm46ICcgK1xuICAgICAgdGhpcy50dXJuICtcbiAgICAgICdcXG4nXG4gICAgbyArPSAnUGxheWVyczogXFxuJ1xuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgTlVNX1BMQVlFUlM7IGkrKykgbyArPSB0aGlzLnBsYXllcnNbaV0udG9Mb2coKSArICdcXG4nXG4gICAgbyArPSAnQmFuazogJyArIHRoaXMuYmFuay50b0xvZygpICsgJ1xcbidcbiAgICBvICs9ICdEZWNrOiAnICsgdGhpcy5kZWNrLnRvTG9nKCkgKyAnXFxuJ1xuICAgIG8gKz0gJ0xhcmdlc3QgQXJteTogJyArIEpTT04uc3RyaW5naWZ5KHRoaXMubGFyZ2VzdEFybXkpICsgJ1xcbidcbiAgICBvICs9ICdMb25nZXN0IFJvYWQ6ICcgKyBKU09OLnN0cmluZ2lmeSh0aGlzLmxvbmdlc3RSb2FkKSArICdcXG4nXG4gICAgbyArPVxuICAgICAgJ0ZyZWUgUm9hZHM6ICcgK1xuICAgICAgdGhpcy5mcmVlUm9hZHMgK1xuICAgICAgJyB8IGhhc1JvbGxlZDogJyArXG4gICAgICB0aGlzLmhhc1JvbGxlZCArXG4gICAgICAnIHwgd2lubmVyOiAnICtcbiAgICAgIHRoaXMud2lubmVyICtcbiAgICAgICdcXG4nXG4gICAgaWYgKHRoaXMubXVzdERpc2NhcmQuaW5jbHVkZXModHJ1ZSkpIG8gKz0gJ211c3REaXNjYXJkOiAnICsgdGhpcy5tdXN0RGlzY2FyZC50b1N0cmluZygpICsgJ1xcbidcbiAgICByZXR1cm4gb1xuICB9XG59XG5cbmV4cG9ydCBkZWZhdWx0IEdhbWVcbiIsIm1vZHVsZS5leHBvcnRzID0gcmVxdWlyZShcInJlYWRsaW5lXCIpOyIsIi8vIFRoZSBtb2R1bGUgY2FjaGVcbnZhciBfX3dlYnBhY2tfbW9kdWxlX2NhY2hlX18gPSB7fTtcblxuLy8gVGhlIHJlcXVpcmUgZnVuY3Rpb25cbmZ1bmN0aW9uIF9fd2VicGFja19yZXF1aXJlX18obW9kdWxlSWQpIHtcblx0Ly8gQ2hlY2sgaWYgbW9kdWxlIGlzIGluIGNhY2hlXG5cdHZhciBjYWNoZWRNb2R1bGUgPSBfX3dlYnBhY2tfbW9kdWxlX2NhY2hlX19bbW9kdWxlSWRdO1xuXHRpZiAoY2FjaGVkTW9kdWxlICE9PSB1bmRlZmluZWQpIHtcblx0XHRyZXR1cm4gY2FjaGVkTW9kdWxlLmV4cG9ydHM7XG5cdH1cblx0Ly8gQ3JlYXRlIGEgbmV3IG1vZHVsZSAoYW5kIHB1dCBpdCBpbnRvIHRoZSBjYWNoZSlcblx0dmFyIG1vZHVsZSA9IF9fd2VicGFja19tb2R1bGVfY2FjaGVfX1ttb2R1bGVJZF0gPSB7XG5cdFx0Ly8gbm8gbW9kdWxlLmlkIG5lZWRlZFxuXHRcdC8vIG5vIG1vZHVsZS5sb2FkZWQgbmVlZGVkXG5cdFx0ZXhwb3J0czoge31cblx0fTtcblxuXHQvLyBFeGVjdXRlIHRoZSBtb2R1bGUgZnVuY3Rpb25cblx0X193ZWJwYWNrX21vZHVsZXNfX1ttb2R1bGVJZF0uY2FsbChtb2R1bGUuZXhwb3J0cywgbW9kdWxlLCBtb2R1bGUuZXhwb3J0cywgX193ZWJwYWNrX3JlcXVpcmVfXyk7XG5cblx0Ly8gUmV0dXJuIHRoZSBleHBvcnRzIG9mIHRoZSBtb2R1bGVcblx0cmV0dXJuIG1vZHVsZS5leHBvcnRzO1xufVxuXG4iLCIvLyBzdGFydHVwXG4vLyBMb2FkIGVudHJ5IG1vZHVsZSBhbmQgcmV0dXJuIGV4cG9ydHNcbi8vIFRoaXMgZW50cnkgbW9kdWxlIGlzIHJlZmVyZW5jZWQgYnkgb3RoZXIgbW9kdWxlcyBzbyBpdCBjYW4ndCBiZSBpbmxpbmVkXG52YXIgX193ZWJwYWNrX2V4cG9ydHNfXyA9IF9fd2VicGFja19yZXF1aXJlX18oNTYyKTtcbiJdLCJuYW1lcyI6WyJtb2R1bGUiLCJleHBvcnRzIiwicmVxdWlyZSIsIl9fd2VicGFja19tb2R1bGVfY2FjaGVfXyIsIl9fd2VicGFja19yZXF1aXJlX18iLCJtb2R1bGVJZCIsImNhY2hlZE1vZHVsZSIsInVuZGVmaW5lZCIsIl9fd2VicGFja19tb2R1bGVzX18iLCJjYWxsIl0sInNvdXJjZVJvb3QiOiIifQ==